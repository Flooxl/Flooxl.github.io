<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>REMEMBER ME ‚Äî Top-Down Cyber Day</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1722ee;
      --panel2:#0f1722cc;
      --text:#e8eef7;
      --muted:#a8b3c5;
      --line:#263449;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --good:#55ff99;
      --warn:#ffcc66;
      --bad:#ff6b6b;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); overflow:hidden; font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    #wrap{position:fixed; inset:0; display:flex;}
    #game{position:relative; flex:1;}
    canvas{display:block; width:100%; height:100%; image-rendering: pixelated; image-rendering: crisp-edges;}
    /* HUD */
    #hud{position:absolute; inset:0; pointer-events:none; padding:12px; display:flex; flex-direction:column; justify-content:space-between;}
    #top{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .chip{
      background: linear-gradient(180deg, #0f1722cc, #0f1722aa);
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      max-width: 56vw;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .badge{padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted);}
    .badge.good{color:var(--good); border-color:#2d7a58;}
    .badge.warn{color:var(--warn); border-color:#7a652d;}
    .badge.bad{color:var(--bad); border-color:#7a2d2d;}
    .hint{color:var(--muted); font-size:12px;}
    #prompt{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      text-align:center;
      opacity:0; transition:opacity .12s ease;
      text-shadow: 0 2px 10px rgba(0,0,0,.6);
      pointer-events:none;
    }
    #prompt .b{font-weight:900; font-size:16px;}
    #prompt .s{color:var(--muted); font-size:12px; margin-top:4px;}
    #toastWrap{position:absolute; left:12px; bottom:12px; width:min(520px,70vw); pointer-events:none; display:flex; flex-direction:column; gap:8px;}
    .toast{
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:12px;
      padding:9px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      opacity:0; transform:translateY(8px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform:translateY(0);}
    .toast .t{font-weight:800;}
    .toast .d{color:var(--muted); font-size:12px; margin-top:2px;}
    /* Overlays */
    #overlay,#phone,#terminal,#report{
      position:absolute; inset:0; z-index:10;
      display:none; align-items:center; justify-content:center;
      background: radial-gradient(1200px 800px at 50% 40%, rgba(13,20,31,.75), rgba(4,6,10,.92));
      backdrop-filter: blur(6px);
      pointer-events:auto;
    }
    #overlay.show,#phone.show,#terminal.show,#report.show{display:flex;}
    .panel{
      width:min(920px,92vw);
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:18px;
      max-height:min(86vh,780px);
      overflow:auto;
    }
    h1{margin:0 0 8px 0; font-size:18px;}
    p{margin:8px 0; color:var(--muted);}
    .btn{
      border:1px solid var(--line);
      background:#0d1520;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      font-weight:800;
    }
    .btn:hover{border-color:#375072;}
    .btn:active{transform:translateY(1px);}
    .btn.primary{background: linear-gradient(180deg, #173253, #0d1520); border-color:#355a86;}
    .btn.good{background: linear-gradient(180deg, #133527, #0d1520); border-color:#2d7a58;}
    .btn.bad{background: linear-gradient(180deg, #3b1c1c, #0d1520); border-color:#7a2d2d;}
    .btn.small{padding:8px 10px;}
    .section{border:1px solid var(--line); border-radius:14px; padding:12px; margin:12px 0; background:#0c121b;}
    .section h2{margin:0 0 8px 0; font-size:14px;}
    .field{display:flex; flex-direction:column; gap:6px; margin:8px 0;}
    .field label{color:var(--muted); font-size:12px;}
    input[type="text"], input[type="password"]{
      background:#0b111a; color:var(--text);
      border:1px solid var(--line); border-radius:12px;
      padding:10px 10px; outline:none;
    }
    .toggle{
      display:flex; align-items:flex-start; gap:10px;
      border:1px solid var(--line); border-radius:12px;
      padding:10px; background:#0b111a; margin:8px 0;
    }
    .toggle input{transform:scale(1.15); margin-top:2px;}
    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px;}
    .item{border:1px solid var(--line); border-radius:12px; padding:10px; background:#0b111a;}
    .item .top{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .item .name{font-weight:900;}
    .item .meta{color:var(--muted); font-size:12px;}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    .hr{height:1px; background:var(--line); margin:10px 0;}
    .grid2{display:grid; grid-template-columns:1.2fr .8fr; gap:12px;}
    @media(max-width:860px){.grid2{grid-template-columns:1fr;}}
    /* Phone tabs */
    #tabs{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .tab{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      user-select:none;
      background:#0d1520;
      color:var(--muted);
      font-weight:900;
    }
    .tab.active{color:var(--text); border-color:#375072; background:#0f1b2a;}
  </style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <canvas id="c"></canvas>

    <div id="hud">
      <div id="top">
        <div class="chip">
          <div class="row">
            <span class="badge warn" id="timeBadge">‚è≥ 08:00</span>
            <span class="badge" id="hintBadge">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏: 3</span>
            <span class="badge" id="zoneBadge">–ó–æ–Ω–∞: ‚Äî</span>
          </div>
          <div class="hint">–¶–µ–ª—å: —É–π—Ç–∏ –¥–æ–º–æ–π —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–æ—á—å—é –Ω–µ —Å–ª—É—á–∏–ª—Å—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç. –ß–µ–∫–ª–∏—Å—Ç–∞ –Ω–µ –±—É–¥–µ—Ç.</div>
        </div>
        <div class="chip">
          <div class="row">
            <span class="badge" id="rendererBadge">2D Canvas</span>
            <span class="badge" id="stateBadge">–°–æ—Å—Ç–æ—è–Ω–∏–µ: MENU</span>
          </div>
          <div class="hint">WASD/—Å—Ç—Ä–µ–ª–∫–∏ ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ ¬∑ E ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å ¬∑ Tab ‚Äî —Å–º–∞—Ä—Ç—Ñ–æ–Ω ¬∑ Esc ‚Äî –∑–∞–∫—Ä—ã—Ç—å/–ø–∞—É–∑–∞</div>
        </div>
      </div>

      <div id="prompt">
        <div class="b" id="promptB">E: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å</div>
        <div class="s" id="promptS">...</div>
      </div>

      <div id="toastWrap"></div>
    </div>

    <!-- MENU -->
    <div id="overlay" class="show">
      <div class="panel">
        <h1>REMEMBER ME ‚Äî —Å–º–µ–Ω–∞ (2D —Å–≤–µ—Ä—Ö—É)</h1>
        <p>–¢—ã —Å—Ç–∞–∂—ë—Ä-–∞–Ω–∞–ª–∏—Ç–∏–∫. –î–Ω—ë–º –≤—Å—ë –≤—ã–≥–ª—è–¥–∏—Ç –æ–±—ã—á–Ω–æ, –Ω–æ –Ω–æ—á—å—é –ª—é–±—ã–µ –Ω–µ–¥–æ—á—ë—Ç—ã –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –∏–Ω—Ü–∏–¥–µ–Ω—Ç.</p>
        <p>–û—Å–º–∞—Ç—Ä–∏–≤–∞–π –∑–æ–Ω—ã, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–π —Å –æ–±—ä–µ–∫—Ç–∞–º–∏, –¥–µ–ª–∞–π —Ä–∞–∑—É–º–Ω—ã–µ –º–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
        <p>–ö–æ–≥–¥–∞ —Ä–µ—à–∏—à—å, —á—Ç–æ –≤—Å—ë –≥–æ—Ç–æ–≤–æ ‚Äî ¬´–£–π—Ç–∏ –¥–æ–º–æ–π¬ª. –ù–æ—á—å –ø—Ä–æ–≤–µ—Ä–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>
        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="btnStart">–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É</button>
          <span class="badge warn">–¢–∞–π–º–µ—Ä: 8 –º–∏–Ω—É—Ç</span>
          <span class="badge">–ü–æ–¥—Å–∫–∞–∑–∫–∏: 3 (‚àí2% –∫–∞–∂–¥–∞—è)</span>
        </div>
      </div>
    </div>

    <!-- PHONE -->
    <div id="phone">
      <div class="panel">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:900;">–°–º–∞—Ä—Ç—Ñ–æ–Ω</div>
            <div class="hint">–ü–æ–º–æ—â—å ¬∑ –ñ—É—Ä–Ω–∞–ª ¬∑ –ü–æ–¥—Å–∫–∞–∑–∫–∞ (–±–µ–∑ —á–µ–∫–ª–∏—Å—Ç–∞)</div>
          </div>
          <div class="row">
            <div id="tabs">
              <div class="tab active" data-tab="help">–ü–æ–º–æ—â—å</div>
              <div class="tab" data-tab="log">–ñ—É—Ä–Ω–∞–ª</div>
              <div class="tab" data-tab="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
            </div>
            <button class="btn small" id="btnClosePhone">–ó–∞–∫—Ä—ã—Ç—å (Tab)</button>
          </div>
        </div>

        <div id="tab_help" style="margin-top:12px;">
          <div class="section">
            <h2>–û—Ä–∏–µ–Ω—Ç–∏—Ä—ã</h2>
            <p>–í –æ—Ñ–∏—Å–µ 6 –∑–æ–Ω –∏ –≤—ã—Ö–æ–¥. –í –∫–∞–∂–¥–æ–π –∑–æ–Ω–µ –µ—Å—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª/–ø—Ä–µ–¥–º–µ—Ç—ã. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –º–µ–ª–æ—á–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã –Ω–æ—á—å—é.</p>
            <p>–ò—â–∏: —Å—Ç–∏–∫–µ—Ä—ã, –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–ª–ª–µ–≥.</p>
          </div>
          <div class="section">
            <h2>–ü–∏–∫—Å–µ–ª—å–Ω–æ—Å—Ç—å</h2>
            <p>–ö–∞—Ä—Ç–∞ —Ä–∏—Å—É–µ—Ç—Å—è –≤ ‚Äú–ø–∏–∫—Å–µ–ª—å–Ω–æ–º‚Äù –º–∞—Å—à—Ç–∞–±–µ. –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –º–∞—Å—à—Ç–∞–± —Ä–µ–Ω–¥–µ—Ä–∞.</p>
            <div class="row">
              <button class="btn small" id="btnPixMinus">‚àí –ü–∏–∫—Å–µ–ª–∏</button>
              <button class="btn small" id="btnPixPlus">+ –ü–∏–∫—Å–µ–ª–∏</button>
              <span class="badge" id="pixInfo">scale: 1.0</span>
            </div>
          </div>
        </div>

        <div id="tab_log" style="display:none; margin-top:12px;">
          <div class="section">
            <h2>–ñ—É—Ä–Ω–∞–ª</h2>
            <div class="hint">–î–µ–π—Å—Ç–≤–∏—è —Å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è–º–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è.</div>
            <div class="hr"></div>
            <div id="logList" class="list"></div>
          </div>
        </div>

        <div id="tab_hint" style="display:none; margin-top:12px;">
          <div class="section">
            <h2>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏</h2>
            <p>–ü–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á. –¢–æ–ª—å–∫–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–Ω–∏–∂–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π %.</p>
            <div class="row">
              <button class="btn small primary" id="btnUseHint">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É</button>
              <span class="badge" id="hintLeft2">–û—Å—Ç–∞–ª–æ—Å—å: 3</span>
              <span class="badge warn">–®—Ç—Ä–∞—Ñ: ‚àí2%</span>
            </div>
            <div class="hr"></div>
            <div class="item">
              <div class="name">–¢–µ–∫—É—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞</div>
              <div class="meta" id="hintText">‚Äî</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- TERMINAL -->
    <div id="terminal">
      <div class="panel">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:900;" id="termTitle">–¢–µ—Ä–º–∏–Ω–∞–ª</div>
            <div class="hint">E ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏. Tab ‚Äî —Å–º–∞—Ä—Ç—Ñ–æ–Ω.</div>
          </div>
          <button class="btn small" id="btnCloseTerminal">–ó–∞–∫—Ä—ã—Ç—å (Esc)</button>
        </div>
        <div id="termBody" style="margin-top:12px;"></div>
      </div>
    </div>

    <!-- REPORT -->
    <div id="report">
      <div class="panel" style="width:min(980px,94vw);">
        <h1 id="repTitle">–û—Ç—á—ë—Ç</h1>
        <p id="repSub" class="hint"></p>
        <div class="grid2">
          <div class="section">
            <h2>–ò—Ç–æ–≥</h2>
            <div class="row">
              <span class="badge" id="repPct">‚Äî%</span>
              <span class="badge" id="repVerdict">‚Äî</span>
              <span class="badge warn" id="repTime">‚Äî</span>
            </div>
            <div class="hr"></div>
            <div id="repSummary" class="list"></div>
          </div>
          <div class="section">
            <h2>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
            <div id="repRecs" class="list"></div>
            <div class="hr"></div>
            <button class="btn primary" id="btnRestart">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
          </div>
        </div>
        <div class="section">
          <h2>–ñ—É—Ä–Ω–∞–ª</h2>
          <div id="repLog" class="list"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
(() => {
  "use strict";

  // ---------- Helpers ----------
  const $ = (s)=>document.querySelector(s);
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const choice = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  const shuffle = (arr)=>{ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };
  const fmtTime = (sec)=>{ sec=Math.max(0,Math.floor(sec)); const m=String(Math.floor(sec/60)).padStart(2,"0"); const s=String(sec%60).padStart(2,"0"); return `${m}:${s}`; };
  const esc = (s)=>String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  const now = ()=>performance.now();

  // ---------- UI ----------
  const el = {
    c: $("#c"),
    overlay: $("#overlay"),
    phone: $("#phone"),
    terminal: $("#terminal"),
    report: $("#report"),

    btnStart: $("#btnStart"),
    btnRestart: $("#btnRestart"),
    btnClosePhone: $("#btnClosePhone"),
    btnCloseTerminal: $("#btnCloseTerminal"),
    btnUseHint: $("#btnUseHint"),
    hintText: $("#hintText"),
    hintLeft2: $("#hintLeft2"),
    hintBadge: $("#hintBadge"),
    timeBadge: $("#timeBadge"),
    zoneBadge: $("#zoneBadge"),
    stateBadge: $("#stateBadge"),
    toastWrap: $("#toastWrap"),
    logList: $("#logList"),

    tabs: Array.from(document.querySelectorAll(".tab")),
    tabHelp: $("#tab_help"),
    tabLog: $("#tab_log"),
    tabHint: $("#tab_hint"),

    btnPixMinus: $("#btnPixMinus"),
    btnPixPlus: $("#btnPixPlus"),
    pixInfo: $("#pixInfo"),

    termTitle: $("#termTitle"),
    termBody: $("#termBody"),

    repTitle: $("#repTitle"),
    repSub: $("#repSub"),
    repPct: $("#repPct"),
    repVerdict: $("#repVerdict"),
    repTime: $("#repTime"),
    repSummary: $("#repSummary"),
    repRecs: $("#repRecs"),
    repLog: $("#repLog"),

    prompt: $("#prompt"),
    promptB: $("#promptB"),
    promptS: $("#promptS")
  };

  // ---------- Scoring ----------
  const PENALTIES = {
    twoFA_off: { pts: 10, msg: "2FA –≤—ã–∫–ª—é—á–µ–Ω–∞ (—Ä–∏—Å–∫ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ —É—á—ë—Ç–∫–∏)" },
    phishing_open: { pts: 5,  msg: "–û—Ç–∫—Ä—ã—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ/–≤–ª–æ–∂–µ–Ω–∏–µ (—Ä–∏—Å–∫ –∑–∞—Ä–∞–∂–µ–Ω–∏—è)" },
    workstation_unlocked: { pts: 3, msg: "–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (–ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø)" },

    usb_left: { pts: 6, msg: "USB –æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –ü–ö (–≤—ã–Ω–æ—Å/–∑–∞—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–æ—Å–∏—Ç–µ–ª—å)" },
    updates_off: { pts: 6, msg: "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã (–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏)" },
    av_not_run: { pts: 4, msg: "–ê–Ω—Ç–∏–≤–∏—Ä—É—Å/—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ" },

    default_password: { pts: 8, msg: "–û—Å—Ç–∞–≤–ª–µ–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å" },
    weak_password: { pts: 6, msg: "–°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å" },
    reused_password: { pts: 6, msg: "–ü–∞—Ä–æ–ª—å –Ω–µ —É–Ω–∏–∫–∞–ª–µ–Ω" },
    browser_pw_on: { pts: 4, msg: "–ü–∞—Ä–æ–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ" },

    unknown_device: { pts: 7, msg: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ —Å–µ—Ç–∏" },
    guest_wifi_on: { pts: 5, msg: "–ì–æ—Å—Ç–µ–≤–æ–π Wi-Fi –≤–∫–ª—é—á—ë–Ω" },
    firmware_old: { pts: 5, msg: "–ü—Ä–æ—à–∏–≤–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞ —É—Å—Ç–∞—Ä–µ–ª–∞" },

    cloud_public: { pts: 8, msg: "–ü—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –≤ –æ–±–ª–∞–∫–µ" },
    cloud_everyone: { pts: 6, msg: "–î–æ—Å—Ç—É–ø '–≤—Å–µ–º –ø–æ —Å—Å—ã–ª–∫–µ'" },
    cloud_alerts_off: { pts: 3, msg: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–µ –≤—ã–∫–ª—é—á–µ–Ω—ã" },

    social_public: { pts: 4, msg: "–ü—Ä–æ—Ñ–∏–ª—å —Å–ª–∏—à–∫–æ–º –ø—É–±–ª–∏—á–Ω—ã–π" },
    social_fake_not_blocked: { pts: 5, msg: "–§–µ–π–∫-–∞–∫–∫–∞—É–Ω—Ç –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" },
    social_dm_open: { pts: 3, msg: "–õ–° —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤—Å–µ–º" },

    hint_used: { pts: 2, msg: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∞" }
  };

  const CRITICAL = [
    "workstationLocked","usbRemoved","updatesOn",
    "twoFAOn","passwordStrongUnique","browserPwOff",
    "phishingSafe","networkSafe","cloudSafe","socialSafe"
  ];

  // ---------- Scenario ----------
  function buildScenario(){
    const legitPool = [
      { from:"hr@corp.local", subj:"–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —É–¥–∞–ª—ë–Ω–∫–∏", body:"–ê–Ω–æ–Ω—Å. –ë–µ–∑ –≤–ª–æ–∂–µ–Ω–∏–π. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç–∞–ª.", kind:"legit", link:"intra://policy" },
      { from:"it@corp.local", subj:"–ü–ª–∞–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ VPN-–∫–ª–∏–µ–Ω—Ç–∞", body:"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤ –ø–æ—Ä—Ç–∞–ª–µ. –í–ª–æ–∂–µ–Ω–∏–π –Ω–µ—Ç.", kind:"legit", link:"intra://vpn" },
      { from:"finance@corp.local", subj:"–û—Ç—á—ë—Ç –ø–æ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞–º", body:"–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä. –ë–µ–∑ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è.", kind:"legit", link:"intra://trips" },
      { from:"teamlead@corp.local", subj:"–°–æ–∑–≤–æ–Ω 16:30", body:"–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ. –ë–µ–∑ —Ñ–∞–π–ª–æ–≤.", kind:"legit", link:"intra://meet" }
    ];
    const phishPool = [
      { from:"security-alert@cor—Ä.local", subj:"–°–†–û–ß–ù–û: –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å", body:"–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–∞–µ—Ç. –í–æ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ.", kind:"phish", link:"http://corp-login.verify-session.example" },
      { from:"delivery@ship-fast.example", subj:"–ù–µ—É–¥–∞—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞: –∞–∫—Ç", body:"–í–ª–æ–∂–µ–Ω–∏–µ 'act.zip'. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å.", kind:"phish", attach:"act.zip" },
      { from:"payments@fin–∞nce.local", subj:"–°—á—ë—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω ‚Äî –æ–ø–ª–∞—Ç–∏—Ç—å", body:"–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É. –î–∞–≤–ª–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏.", kind:"phish", link:"http://pay-now.invoice-check.example" }
    ];
    const emails = shuffle([...legitPool]).slice(0,4);
    const phCount = (Math.random()<0.55)?2:1;
    const idxs = shuffle([0,1,2,3]).slice(0,phCount);
    const picked = shuffle([...phishPool]).slice(0,phCount);
    idxs.forEach((i,k)=>emails[i]=picked[k]);

    const known = [
      { name:"Office-PC", mac:"A4:11:2C:9D:1F:02", trust:"known" },
      { name:"Printer-3F", mac:"B0:22:10:AA:77:03", trust:"known" },
      { name:"Meeting-TV", mac:"10:9F:EA:01:02:03", trust:"known" }
    ];
    const suspicious = { name: choice(["Android-??","iPhone-??","ESP32-Board","Unknown-Device"]), mac:"DE:AD:BE:EF:"+String(Math.floor(Math.random()*90+10))+":"+String(Math.floor(Math.random()*90+10)), trust:"unknown" };
    const devices = shuffle([...known, suspicious]);

    const folders = shuffle([
      { name:"Roadmap_Q1", share:"team", publicLink:false },
      { name:"Incidents_Notes", share:"team", publicLink:true },
      { name:"Budget_Drafts", share:"everyone", publicLink:false },
      { name:"Onboarding", share:"team", publicLink:false }
    ]).slice(0,4);
    if(!folders.some(f=>f.publicLink)) folders[0].publicLink = true;
    if(!folders.some(f=>f.share==="everyone") && Math.random()<0.8) folders[1].share="everyone";

    const fakeAccount = {
      name: choice(["hr-support_official","it_helpdesk_secure","corp.security.team","teamlead_backup"]),
      note:"–ü–æ—Ö–æ–∂–µ–µ –∏–º—è –∏ –∞–≤–∞—Ç–∞—Ä. –ü—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.",
      blocked:false
    };

    return { emails, devices, folders, fakeAccount };
  }

  // ---------- Game State ----------
  const State = Object.freeze({ MENU:"MENU", PLAY:"PLAY", PAUSE:"PAUSE", PHONE:"PHONE", TERM:"TERM", REPORT:"REPORT" });

  const game = {
    state: State.MENU,
    dayLen: 8*60,
    timeLeft: 8*60,
    score: 100,
    hintsLeft: 3,
    hintsUsed: 0,
    logs: [],
    scenario: buildScenario(),
    checks: {
      workstationLocked:false, usbRemoved:false, updatesOn:false, avRun:false,
      passwordChanged:false, passwordStrong:false, passwordUnique:false, twoFAOn:false, browserPwOff:false,
      phishingSafe:true, phishingReported:0, phishingOpened:0,
      unknownDeviceRemoved:false, guestWifiOff:false, firmwareUpdated:false,
      cloudNoPublicLinks:false, cloudNoEveryone:false, cloudAlertsOn:false,
      socialPrivacyTight:false, socialFakeBlocked:false, socialDmRestricted:false,
      // derived
      passwordStrongUnique:false, networkSafe:false, cloudSafe:false, socialSafe:false
    }
  };

  // ---------- Map & Entities ----------
  // World coordinates in "cells" (float). We'll render with scale.
  const world = {
    w: 26, h: 18, // office bounds
    // zones are just labels by position
    objects: [], // interactables
    player: { x: 2.2, y: 9.0, vx:0, vy:0, speed: 6.0 },
    // render scale (pixelation)
    renderScale: 1.0,
    // near interaction
    hover: null
  };

  function resetObjects(){
    // Place 6 zones (left to right, top to bottom) + exit
    world.objects = [
      { id:"workstation", name:"–°—Ç–æ–ª: –ü–ö/USB", x: 4,  y: 4,  r:1.2, zone:"–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ" },
      { id:"accounts",    name:"–¢–µ—Ä–º–∏–Ω–∞–ª —É—á—ë—Ç–æ–∫", x: 4,  y: 14, r:1.2, zone:"–£—á—ë—Ç–∫–∏ –∏ –ø–∞—Ä–æ–ª–∏" },
      { id:"mail",        name:"–ü–æ—á—Ç–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª", x: 13, y: 4,  r:1.2, zone:"–ü–æ—á—Ç–∞" },
      { id:"network",     name:"–†–æ—É—Ç–µ—Ä/—â–∏—Ç–æ–∫", x: 13, y: 14, r:1.3, zone:"–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç—å" },
      { id:"cloud",       name:"–û–±–ª–∞—á–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª", x: 22, y: 4,  r:1.2, zone:"–û–±–ª–∞–∫–æ" },
      { id:"social",      name:"–°–æ—Ü—Å–µ—Ç–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª", x: 22, y: 14, r:1.2, zone:"–°–æ—Ü—Å–µ—Ç–∏" },
      { id:"home",        name:"–î–≤–µ—Ä—å –¥–æ–º–æ–π", x: 25.0, y: 9.0, r:1.35, zone:"–í—ã—Ö–æ–¥" },
    ];
    world.player.x = 2.2;
    world.player.y = 9.0;
    world.player.vx = 0; world.player.vy=0;
  }

  // ---------- UI / Logs / Toast ----------
  function logEvent(title, detail){
    const ts = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    game.logs.push({ts, title, detail});
    renderLogList();

    const t = document.createElement("div");
    t.className = "toast";
    t.innerHTML = `<div class="t">${esc(title)}</div><div class="d">${esc(detail)}</div>`;
    el.toastWrap.prepend(t);
    requestAnimationFrame(()=>t.classList.add("show"));
    setTimeout(()=>{ t.classList.remove("show"); setTimeout(()=>t.remove(), 250); }, 2400);
  }

  function renderLogList(){
    el.logList.innerHTML = "";
    const last = game.logs.slice(-60).reverse();
    if(!last.length){
      el.logList.innerHTML = `<div class="item"><div class="meta">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div></div>`;
      return;
    }
    for(const e of last){
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `<div class="top"><div><div class="name">${esc(e.title)}</div><div class="meta">${esc(e.detail)}</div></div><div class="meta mono">${esc(e.ts)}</div></div>`;
      el.logList.appendChild(it);
    }
  }

  function setState(s){
    game.state = s;
    el.stateBadge.textContent = `–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${s}`;
    el.overlay.classList.toggle("show", s===State.MENU);
    el.phone.classList.toggle("show", s===State.PHONE);
    el.terminal.classList.toggle("show", s===State.TERM);
    el.report.classList.toggle("show", s===State.REPORT);
  }

  function updateHUD(){
    el.timeBadge.textContent = `‚è≥ ${fmtTime(game.timeLeft)}`;
    el.hintBadge.textContent = `üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏: ${game.hintsLeft}`;
    el.hintLeft2.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${game.hintsLeft}`;
    el.zoneBadge.textContent = `–ó–æ–Ω–∞: ${zoneFromPos(world.player.x, world.player.y)}`;
  }

  // ---------- Tabs ----------
  function setTab(name){
    el.tabs.forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
    el.tabHelp.style.display = (name==="help")?"":"none";
    el.tabLog.style.display  = (name==="log")?"":"none";
    el.tabHint.style.display = (name==="hint")?"":"none";
    if(name==="log") renderLogList();
  }
  el.tabs.forEach(t=>t.addEventListener("click", ()=>setTab(t.dataset.tab)));
  el.btnClosePhone.addEventListener("click", ()=>{ if(game.state===State.PHONE) setState(State.PLAY); });

  // ---------- Hints ----------
  function computeHint(){
    const c = game.checks;
    const candidates = [];
    if(!c.workstationLocked || !c.usbRemoved || !c.updatesOn) candidates.push("–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ: —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø, –Ω–æ—Å–∏—Ç–µ–ª–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ—à–∞—é—Ç –∏—Å—Ö–æ–¥ –Ω–æ—á–∏.");
    if(!c.twoFAOn || !c.browserPwOff || !(c.passwordChanged && c.passwordStrong && c.passwordUnique)) candidates.push("–£—á—ë—Ç–∫–∏: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ/–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ 2FA —á–∞—â–µ –≤—Å–µ–≥–æ –ª–æ–º–∞—é—Ç –ø–µ—Ä–≤—ã–º–∏.");
    if(c.phishingSafe && c.phishingReported===0 && game.scenario.emails.some(e=>e.kind==="phish")) candidates.push("–ü–æ—á—Ç–∞: —Å—Ä–æ—á–Ω–æ—Å—Ç—å, –≤–Ω–µ—à–Ω–∏–µ –¥–æ–º–µ–Ω—ã –∏ –≤–ª–æ–∂–µ–Ω–∏—è ‚Äî —Ç–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ñ–∏—à–∏–Ω–≥–∞.");
    if(!c.unknownDeviceRemoved || !c.guestWifiOff || !c.firmwareUpdated) candidates.push("–°–µ—Ç—å: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –≥–æ—Å—Ç–µ–≤–æ–π Wi-Fi –∏ –ø—Ä–æ—à–∏–≤–∫–∞ ‚Äî —á–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–æ—á–Ω—ã—Ö —Å—é—Ä–ø—Ä–∏–∑–æ–≤.");
    if(!c.cloudNoPublicLinks || !c.cloudNoEveryone || !c.cloudAlertsOn) candidates.push("–û–±–ª–∞–∫–æ: –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏/–ø—Ä–∞–≤–∞ ¬´–≤—Å–µ–º¬ª –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–ª–µ—Ä—Ç–æ–≤ —á–∞—Å—Ç–æ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —É—Ç–µ—á–∫–∞–º.");
    if(!c.socialPrivacyTight || !c.socialFakeBlocked || !c.socialDmRestricted) candidates.push("–°–æ—Ü—Å–µ—Ç–∏: —Ñ–µ–π–∫–∏, –ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å –∏ –õ–° ¬´–¥–ª—è –≤—Å–µ—Ö¬ª –ø–æ–º–æ–≥–∞—é—Ç —Å–æ—Ü–∏–Ω–∂–µ–Ω–µ—Ä–∏–∏.");
    if(!candidates.length) candidates.push("–ü–æ—Ö–æ–∂–µ, –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∏—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã. –ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤—ã—Ö–æ–¥.");
    return choice(candidates);
  }

  function useHint(){
    if(game.hintsLeft<=0) return;
    game.hintsLeft--;
    game.hintsUsed++;
    game.score = Math.max(0, game.score - PENALTIES.hint_used.pts);
    el.hintText.textContent = computeHint();
    logEvent("–ü–æ–¥—Å–∫–∞–∑–∫–∞", "–ù–∞–º—ë–∫ –≤—ã–¥–∞–Ω. –ò—Ç–æ–≥–æ–≤—ã–π % —Å–Ω–∏–∂–µ–Ω.");
    updateHUD();
  }
  el.btnUseHint.addEventListener("click", useHint);

  // ---------- Render (pixelated canvas) ----------
  const ctx = el.c.getContext("2d", {alpha:false});
  let view = { w:0, h:0, scale:1, cell:20, pad:12 };

  function resize(){
    const W = el.c.clientWidth || window.innerWidth;
    const H = el.c.clientHeight || window.innerHeight;

    // Internal resolution smaller to get pixel look
    const s = world.renderScale; // 0.6..1.6
    const iw = Math.max(320, Math.floor(W * (0.75 / s)));
    const ih = Math.max(240, Math.floor(H * (0.75 / s)));
    el.c.width = iw;
    el.c.height = ih;

    view.w = iw; view.h = ih;
    view.pad = 10;
    view.cell = Math.floor(Math.min((iw - view.pad*2)/world.w, (ih - view.pad*2)/world.h));
    view.scale = 1;

    el.pixInfo.textContent = `scale: ${world.renderScale.toFixed(2)}`;
  }
  window.addEventListener("resize", resize);

  el.btnPixMinus.addEventListener("click", ()=>{ world.renderScale = clamp(world.renderScale*0.90, 0.6, 1.8); resize(); });
  el.btnPixPlus.addEventListener("click", ()=>{ world.renderScale = clamp(world.renderScale*1.10, 0.6, 1.8); resize(); });

  function toScreen(x,y){
    const px = view.pad + x*view.cell;
    const py = view.pad + y*view.cell;
    return {x:px, y:py};
  }

  function zoneFromPos(x,y){
    // 3 columns (0..26), 2 rows (0..18)
    if(x > 23.5 && Math.abs(y-9)<2.2) return "–í—ã—Ö–æ–¥";
    const left = x < 8.7;
    const right = x > 17.3;
    const top = y > 9;
    if(left && !top) return "–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ";
    if(left && top)  return "–£—á—ë—Ç–∫–∏ –∏ –ø–∞—Ä–æ–ª–∏";
    if(!left && !right && !top) return "–ü–æ—á—Ç–∞";
    if(!left && !right && top)  return "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç—å";
    if(right && !top) return "–û–±–ª–∞–∫–æ";
    if(right && top)  return "–°–æ—Ü—Å–µ—Ç–∏";
    return "–û—Ñ–∏—Å";
  }

  function draw(){
    // background
    ctx.fillStyle = "#0b0f14";
    ctx.fillRect(0,0,view.w,view.h);

    // floor
    ctx.fillStyle = "#101826";
    const ox=view.pad, oy=view.pad, fw=world.w*view.cell, fh=world.h*view.cell;
    ctx.fillRect(ox,oy,fw,fh);

    // walls border
    ctx.fillStyle = "#162235";
    ctx.fillRect(ox,oy,fw,2);
    ctx.fillRect(ox,oy+fh-2,fw,2);
    ctx.fillRect(ox,oy,2,fh);
    ctx.fillRect(ox+fw-2,oy,2,fh);

    // partitions (same idea)
    ctx.fillStyle = "#162235";
    // vertical lines x=8.7 and x=17.3 approx
    const vx1 = toScreen(8.7,0).x;
    const vx2 = toScreen(17.3,0).x;
    ctx.fillRect(vx1-1, oy+toScreen(0,2).y-oy, 2, fh-4*view.cell);
    ctx.fillRect(vx2-1, oy+toScreen(0,2).y-oy, 2, fh-4*view.cell);
    // horizontal line y=9
    const hy = toScreen(0,9).y;
    ctx.fillRect(ox+toScreen(2,0).x-ox, hy-1, fw-4*view.cell, 2);

    // zone labels (tiny)
    ctx.fillStyle = "rgba(232,238,247,.8)";
    ctx.font = "10px ui-monospace, Menlo, Consolas, monospace";
    ctx.fillText("1: –†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ", toScreen(1.2,1.2).x, toScreen(1.2,1.2).y);
    ctx.fillText("2: –£—á—ë—Ç–∫–∏", toScreen(1.2,10.2).x, toScreen(1.2,10.2).y);
    ctx.fillText("3: –ü–æ—á—Ç–∞", toScreen(10.0,1.2).x, toScreen(10.0,1.2).y);
    ctx.fillText("4: –°–µ—Ç—å", toScreen(10.0,10.2).x, toScreen(10.0,10.2).y);
    ctx.fillText("5: –û–±–ª–∞–∫–æ", toScreen(19.2,1.2).x, toScreen(19.2,1.2).y);
    ctx.fillText("6: –°–æ—Ü—Å–µ—Ç–∏", toScreen(19.2,10.2).x, toScreen(19.2,10.2).y);

    // objects
    for(const o of world.objects){
      const p = toScreen(o.x, o.y);
      const size = (o.id==="home") ? 10 : 8;
      ctx.fillStyle = (o.id==="home") ? "#25364f" : "#0b111a";
      ctx.fillRect(p.x-size/2, p.y-size/2, size, size);
      // glow dot
      const blink = (o.id==="network" && (Math.sin(now()*0.004)>-0.15));
      ctx.fillStyle = blink ? "#4de3a8" : "rgba(77,227,168,.65)";
      ctx.fillRect(p.x-1, p.y-1, 2, 2);
    }

    // player
    const pp = toScreen(world.player.x, world.player.y);
    ctx.fillStyle = "#e8eef7";
    ctx.fillRect(pp.x-2, pp.y-2, 4, 4);
    ctx.fillStyle = "#ffcc66";
    ctx.fillRect(pp.x+3, pp.y-1, 2, 2);
  }

  // ---------- Input & Interaction ----------
  const keys = new Set();
  window.addEventListener("keydown", (e)=>{
    if(e.code==="Tab"){
      e.preventDefault();
      if(game.state===State.PLAY){ setTab("help"); setState(State.PHONE); }
      else if(game.state===State.PHONE){ setState(State.PLAY); }
      return;
    }
    if(e.code==="Escape"){
      if(game.state===State.TERM){ closeTerminal(); return; }
      if(game.state===State.PHONE){ setState(State.PLAY); return; }
      if(game.state===State.PLAY){ setState(State.PAUSE); return; }
      if(game.state===State.PAUSE){ setState(State.PLAY); return; }
      return;
    }
    keys.add(e.code);
    if(e.code==="KeyE"){
      if(game.state===State.PLAY) tryInteract();
    }
  });
  window.addEventListener("keyup", (e)=>keys.delete(e.code));

  function nearestInteractable(){
    let best=null, bestD=1e9;
    for(const o of world.objects){
      const d = Math.hypot(world.player.x-o.x, world.player.y-o.y);
      if(d < o.r && d < bestD){ best=o; bestD=d; }
    }
    return best;
  }

  function showPrompt(on, big, small){
    el.prompt.style.opacity = on ? "1" : "0";
    el.promptB.textContent = big || "E: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å";
    el.promptS.textContent = small || "";
  }

  function tryInteract(){
    const o = nearestInteractable();
    if(!o) return;
    openTerminal(o.id, o.name, o.zone);
    logEvent("–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ", `–û—Ç–∫—Ä—ã—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: ${o.name}.`);
  }

  // ---------- Terminal UI ----------
  let activeTask = null;

  function openTerminal(id, title, zone){
    activeTask = id;
    el.termTitle.textContent = `${title} ‚Äî ${zone}`;
    el.termBody.innerHTML = "";
    el.termBody.appendChild(buildTaskUI(id));
    setState(State.TERM);
  }

  function closeTerminal(){
    activeTask = null;
    el.termBody.innerHTML = "";
    if(game.state===State.TERM) setState(State.PLAY);
  }
  el.btnCloseTerminal.addEventListener("click", closeTerminal);

  function taskContent_workstation(){
    const c = game.checks;
    const root = document.createElement("div");
    root.innerHTML = `
      <div class="section">
        <h2>–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ ‚Äî –ü–ö</h2>
        <p>–°—Ç–∏–∫–µ—Ä –Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä–µ: ¬´–ü–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º: Win+L, –Ω–æ—Å–∏—Ç–µ–ª–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è¬ª.</p>

        <div class="toggle">
          <input id="ws_lock" type="checkbox" ${c.workstationLocked?"checked":""}/>
          <div>
            <div class="name">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏—é –ø–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º</div>
            <div class="meta">–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º ‚Äî –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø –Ω–æ—á—å—é.</div>
          </div>
        </div>

        <div class="toggle">
          <input id="ws_usb" type="checkbox" ${c.usbRemoved?"checked":""}/>
          <div>
            <div class="name">–ò–∑–≤–ª–µ—á—å USB-—Ñ–ª–µ—à–∫—É</div>
            <div class="meta">–ù–æ—Å–∏—Ç–µ–ª—å ‚Äî —á–∞—Å—Ç—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞—Ä–∞–∂–µ–Ω–∏—è/–≤—ã–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö.</div>
          </div>
        </div>

        <div class="toggle">
          <input id="ws_updates" type="checkbox" ${c.updatesOn?"checked":""}/>
          <div>
            <div class="name">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</div>
            <div class="meta">–í—ã–∫–ª—é—á–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–≤—ã—à–∞—é—Ç —Ä–∏—Å–∫ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π.</div>
          </div>
        </div>

        <div class="row">
          <button class="btn small good" id="ws_scan">–ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ã—Å—Ç—Ä—É—é –ø—Ä–æ–≤–µ—Ä–∫—É</button>
          <span class="badge ${c.avRun?"good":"warn"}" id="ws_scan_badge">${c.avRun?"–ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—ã–ø–æ–ª–Ω–µ–Ω–∞":"–ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å"}</span>
        </div>
      </div>
    `;
    root.querySelector("#ws_lock").addEventListener("change",(e)=>{ c.workstationLocked=e.target.checked; logEvent("–ü–ö", c.workstationLocked?"–°–µ—Å—Å–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞.":"–°–µ—Å—Å–∏—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π."); });
    root.querySelector("#ws_usb").addEventListener("change",(e)=>{ c.usbRemoved=e.target.checked; logEvent("USB", c.usbRemoved?"USB –∏–∑–≤–ª–µ—á—ë–Ω.":"USB –æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –ü–ö."); });
    root.querySelector("#ws_updates").addEventListener("change",(e)=>{ c.updatesOn=e.target.checked; logEvent("–û–±–Ω–æ–≤–ª–µ–Ω–∏—è", c.updatesOn?"–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã.":"–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã."); });
    root.querySelector("#ws_scan").addEventListener("click",()=>{
      c.avRun=true;
      const b=root.querySelector("#ws_scan_badge");
      b.textContent="–ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"; b.className="badge good";
      logEvent("–ü—Ä–æ–≤–µ—Ä–∫–∞","–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω—ã).");
    });
    return root;
  }

  function taskContent_accounts(){
    const c = game.checks;
    const root = document.createElement("div");
    root.innerHTML = `
      <div class="section">
        <h2>–£—á—ë—Ç–∫–∏ –∏ –ø–∞—Ä–æ–ª–∏</h2>
        <p>–ö–æ–ª–ª–µ–≥–∞: ¬´–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å—Ç–∞–∂—ë—Ä—Å–∫–∏–π –ø–∞—Ä–æ–ª—å –Ω–µ –æ—Å—Ç–∞–ª—Å—è 'Welcome123'¬ª.</p>

        <div class="field">
          <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è, —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª)</label>
          <input id="acc_pwd" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å..." />
          <div class="hint">–ü—Ä–∞–≤–∏–ª–∞: –¥–ª–∏–Ω–∞ ‚â• 12, —Ä–∞–∑–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä, —Ü–∏—Ñ—Ä—ã, —Å–∏–º–≤–æ–ª. –ù–µ –ø–æ—Ö–æ–∂ –Ω–∞ 'Welcome123'.</div>
        </div>

        <div class="toggle">
          <input id="acc_unique" type="checkbox" ${c.passwordUnique?"checked":""}/>
          <div>
            <div class="name">–ü–∞—Ä–æ–ª—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π (–Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏)</div>
            <div class="meta">–ü–æ–≤—Ç–æ—Ä –ø–∞—Ä–æ–ª–µ–π ‚Üí credential stuffing.</div>
          </div>
        </div>

        <div class="toggle">
          <input id="acc_2fa" type="checkbox" ${c.twoFAOn?"checked":""}/>
          <div>
            <div class="name">–í–∫–ª—é—á–∏—Ç—å 2FA</div>
            <div class="meta">–ë–µ–∑ 2FA –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è —É—á—ë—Ç–∫–∏ –æ–±—ã—á–Ω–æ –≤–æ–ø—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏.</div>
          </div>
        </div>

        <div class="toggle">
          <input id="acc_browser" type="checkbox" ${!c.browserPwOff?"checked":""}/>
          <div>
            <div class="name">–†–∞–∑—Ä–µ—à–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
            <div class="meta">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç–∫–ª—é—á–∏—Ç—å –Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏—è—Ö.</div>
          </div>
        </div>

        <div class="row">
          <span class="badge ${!c.passwordChanged?"bad":"good"}" id="acc_default">${!c.passwordChanged?"–°—Ç–∞—Ç—É—Å: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å":"–°—Ç–∞—Ç—É—Å: –ø–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω"}</span>
          <span class="badge ${c.passwordStrong?"good":"warn"}" id="acc_strength">${c.passwordStrong?"–°–∏–ª–∞: –æ–∫":"–°–∏–ª–∞: —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ"}</span>
          <span class="badge ${c.passwordUnique?"good":"warn"}" id="acc_uniq_badge">${c.passwordUnique?"–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –æ–∫":"–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞"}</span>
        </div>

        <div class="hr"></div>
        <button class="btn small primary" id="acc_apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    `;

    const inp = root.querySelector("#acc_pwd");
    const tUnique = root.querySelector("#acc_unique");
    const t2fa = root.querySelector("#acc_2fa");
    const tBrowser = root.querySelector("#acc_browser");

    function strong(p){
      if(!p) return false;
      if(p.toLowerCase().includes("welcome")) return false;
      if(p.length<12) return false;
      const hasU=/[A-Z]/.test(p), hasL=/[a-z]/.test(p), hasD=/\d/.test(p), hasS=/[^A-Za-z0-9]/.test(p);
      return hasU&&hasL&&hasD&&hasS;
    }

    root.querySelector("#acc_apply").addEventListener("click", ()=>{
      const p = inp.value || "";
      c.passwordChanged = p.length>0;
      c.passwordStrong = strong(p);
      c.passwordUnique = !!tUnique.checked;
      c.twoFAOn = !!t2fa.checked;
      c.browserPwOff = !tBrowser.checked;

      root.querySelector("#acc_default").textContent = c.passwordChanged?"–°—Ç–∞—Ç—É—Å: –ø–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω":"–°—Ç–∞—Ç—É—Å: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å";
      root.querySelector("#acc_default").className = "badge "+(c.passwordChanged?"good":"bad");

      root.querySelector("#acc_strength").textContent = c.passwordStrong?"–°–∏–ª–∞: –æ–∫":"–°–∏–ª–∞: —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ";
      root.querySelector("#acc_strength").className = "badge "+(c.passwordStrong?"good":"warn");

      root.querySelector("#acc_uniq_badge").textContent = c.passwordUnique?"–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –æ–∫":"–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞";
      root.querySelector("#acc_uniq_badge").className = "badge "+(c.passwordUnique?"good":"warn");

      logEvent("–£—á—ë—Ç–∫–∏","–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—á—ë—Ç–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã.");
      if(c.twoFAOn) logEvent("2FA","2FA –≤–∫–ª—é—á–µ–Ω–∞.");
      if(c.browserPwOff) logEvent("–ë—Ä–∞—É–∑–µ—Ä","–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –æ—Ç–∫–ª—é—á–µ–Ω–æ.");
    });

    return root;
  }

  function taskContent_mail(){
    const c = game.checks;
    const sc = game.scenario;
    const root = document.createElement("div");

    const emailsHtml = sc.emails.map((m,i)=>{
      const kindTag = (m.kind==="phish") ? `<span class="badge bad">–ø–æ–¥–æ–∑—Ä.</span>` : `<span class="badge good">–≤–Ω—É—Ç—Ä.</span>`;
      const attach = m.attach ? ` ¬∑ <span class="badge warn">–≤–ª–æ–∂–µ–Ω–∏–µ: ${esc(m.attach)}</span>` : "";
      const link = m.link ? ` ¬∑ <span class="badge">${esc(m.link.startsWith("intra://")?"–≤–Ω—É—Ç—Ä. —Å—Å—ã–ª–∫–∞":"–≤–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞")}</span>` : "";
      return `
        <div class="item" data-mail="${i}">
          <div class="top">
            <div>
              <div class="name">${esc(m.subj)} ${kindTag}</div>
              <div class="meta">–û—Ç: <span class="mono">${esc(m.from)}</span>${attach}${link}</div>
            </div>
            <div class="meta mono">#${i+1}</div>
          </div>
          <div class="meta" style="margin-top:6px">${esc(m.body)}</div>
          <div class="actions">
            <button class="btn small" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
            <button class="btn small" data-act="report">–°–æ–æ–±—â–∏—Ç—å –∫–∞–∫ —Ñ–∏—à–∏–Ω–≥</button>
            <button class="btn small" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `;
    }).join("");

    root.innerHTML = `
      <div class="section">
        <h2>–ü–æ—á—Ç–∞</h2>
        <p>–°—Ç–∏–∫–µ—Ä: ¬´–ù–µ —Å–ø–µ—à–∏. –°–º–æ—Ç—Ä–∏ –¥–æ–º–µ–Ω, —Å—Ä–æ—á–Ω–æ—Å—Ç—å, –≤–ª–æ–∂–µ–Ω–∏—è –∏ –≤–Ω–µ—à–Ω–∏–π URL¬ª.</p>
        <div class="list">${emailsHtml}</div>
        <div class="hr"></div>
        <div class="row">
          <span class="badge ${c.phishingOpened>0?"bad":"good"}" id="mail_opened">–û—Ç–∫—Ä—ã—Ç–æ –ø–æ–¥–æ–∑—Ä.: ${c.phishingOpened}</span>
          <span class="badge" id="mail_reported">–°–æ–æ–±—â–µ–Ω–æ: ${c.phishingReported}</span>
        </div>
      </div>
    `;

    root.querySelectorAll("[data-mail]").forEach(card=>{
      const idx = Number(card.getAttribute("data-mail"));
      const msg = sc.emails[idx];
      card.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          if(act==="open"){
            logEvent("–ü–æ—á—Ç–∞", `–û—Ç–∫—Ä—ã—Ç–æ –ø–∏—Å—å–º–æ: "${msg.subj}".`);
            if(msg.kind==="phish"){
              c.phishingSafe = false;
              c.phishingOpened++;
              logEvent("–†–∏—Å–∫","–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ. –ù–æ—á—å—é —ç—Ç–æ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –∑–∞—Ä–∞–∂–µ–Ω–∏–µ–º.");
              const b = root.querySelector("#mail_opened");
              b.textContent = `–û—Ç–∫—Ä—ã—Ç–æ –ø–æ–¥–æ–∑—Ä.: ${c.phishingOpened}`;
              b.className = "badge bad";
            }
          } else if(act==="report"){
            if(msg.kind==="phish"){
              c.phishingReported++;
              logEvent("–ü–æ—á—Ç–∞", `–°–æ–æ–±—â–µ–Ω–æ –ò–ë: "${msg.subj}".`);
            } else {
              logEvent("–ü–æ—á—Ç–∞", `–ü–æ–º–µ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: "${msg.subj}" (–≤–æ–∑–º–æ–∂–Ω–æ –ª–æ–∂–Ω–æ–µ).`);
            }
            root.querySelector("#mail_reported").textContent = `–°–æ–æ–±—â–µ–Ω–æ: ${c.phishingReported}`;
          } else if(act==="delete"){
            logEvent("–ü–æ—á—Ç–∞", `–£–¥–∞–ª–µ–Ω–æ –ø–∏—Å—å–º–æ: "${msg.subj}".`);
            card.style.opacity = .55;
            card.querySelectorAll("button").forEach(b=>b.disabled=true);
          }
        });
      });
    });

    return root;
  }

  function taskContent_network(){
    const c = game.checks;
    const sc = game.scenario;
    const root = document.createElement("div");

    const devHtml = sc.devices.map((d,i)=>{
      const badge = d.trust==="unknown" ? `<span class="badge bad">–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>` : `<span class="badge good">–∏–∑–≤–µ—Å—Ç–Ω–æ</span>`;
      return `
        <div class="item" data-dev="${i}">
          <div class="top">
            <div>
              <div class="name">${esc(d.name)} ${badge}</div>
              <div class="meta mono">${esc(d.mac)}</div>
            </div>
            <div class="meta">${d.trust==="unknown"?"‚ö†":"‚úì"}</div>
          </div>
          <div class="actions">
            <button class="btn small" data-act="kick">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
            <button class="btn small" data-act="whitelist">–î–æ–≤–µ—Ä—è—Ç—å</button>
          </div>
        </div>
      `;
    }).join("");

    root.innerHTML = `
      <div class="section">
        <h2>–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç—å</h2>
        <p>–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä: ¬´–ù–æ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å: 1¬ª. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ‚Äî –ª—É—á—à–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ.</p>

        <div class="toggle">
          <input id="net_guest" type="checkbox" ${!c.guestWifiOff?"checked":""}/>
          <div>
            <div class="name">–ì–æ—Å—Ç–µ–≤–æ–π Wi-Fi –≤–∫–ª—é—á—ë–Ω</div>
            <div class="meta">–ï—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å.</div>
          </div>
        </div>

        <div class="row">
          <button class="btn small good" id="net_fw">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—à–∏–≤–∫—É</button>
          <span class="badge ${c.firmwareUpdated?"good":"warn"}" id="net_fw_badge">${c.firmwareUpdated?"–ü—Ä–æ—à–∏–≤–∫–∞: –∞–∫—Ç—É–∞–ª—å–Ω–∞":"–ü—Ä–æ—à–∏–≤–∫–∞: —É—Å—Ç–∞—Ä–µ–ª–∞"}</span>
        </div>

        <div class="hr"></div>
        <div class="name">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
        <div class="list">${devHtml}</div>

        <div class="hr"></div>
        <span class="badge ${c.unknownDeviceRemoved?"good":"warn"}" id="net_unknown">${c.unknownDeviceRemoved?"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã":"–ï—Å—Ç—å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"}</span>
      </div>
    `;

    const tGuest = root.querySelector("#net_guest");
    tGuest.addEventListener("change", ()=>{
      c.guestWifiOff = !tGuest.checked;
      logEvent("–°–µ—Ç—å", c.guestWifiOff?"–ì–æ—Å—Ç–µ–≤–æ–π Wi-Fi –≤—ã–∫–ª—é—á–µ–Ω.":"–ì–æ—Å—Ç–µ–≤–æ–π Wi-Fi –≤–∫–ª—é—á—ë–Ω.");
    });

    root.querySelector("#net_fw").addEventListener("click", ()=>{
      c.firmwareUpdated = true;
      const b = root.querySelector("#net_fw_badge");
      b.textContent = "–ü—Ä–æ—à–∏–≤–∫–∞: –∞–∫—Ç—É–∞–ª—å–Ω–∞";
      b.className = "badge good";
      logEvent("–°–µ—Ç—å","–ü—Ä–æ—à–∏–≤–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.");
    });

    root.querySelectorAll("[data-dev]").forEach(card=>{
      const idx = Number(card.getAttribute("data-dev"));
      const dev = sc.devices[idx];
      card.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          if(act==="kick"){
            if(dev.trust==="unknown"){
              c.unknownDeviceRemoved = true;
              const b = root.querySelector("#net_unknown");
              b.textContent = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã";
              b.className = "badge good";
              logEvent("–°–µ—Ç—å", `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ (${dev.name}).`);
            } else {
              logEvent("–°–µ—Ç—å", `–û—Ç–∫–ª—é—á–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (${dev.name}).`);
            }
            card.style.opacity=.55;
            card.querySelectorAll("button").forEach(b=>b.disabled=true);
          } else if(act==="whitelist"){
            if(dev.trust==="unknown"){
              logEvent("–°–µ—Ç—å", `–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–º–µ—á–µ–Ω–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º (${dev.name}).`);
            } else {
              logEvent("–°–µ—Ç—å", `–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–∂–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ (${dev.name}).`);
            }
          }
        });
      });
    });

    return root;
  }

  function taskContent_cloud(){
    const c = game.checks;
    const sc = game.scenario;
    const root = document.createElement("div");

    const folderHtml = sc.folders.map((f,i)=>{
      const pub = f.publicLink ? `<span class="badge bad">–ø—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞</span>` : `<span class="badge good">–±–µ–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫</span>`;
      const share = f.share==="everyone" ? `<span class="badge warn">–¥–æ—Å—Ç—É–ø: –≤—Å–µ–º</span>` : `<span class="badge good">–¥–æ—Å—Ç—É–ø: –∫–æ–º–∞–Ω–¥–∞</span>`;
      return `
        <div class="item" data-fold="${i}">
          <div class="top">
            <div>
              <div class="name">${esc(f.name)}</div>
              <div class="meta">${pub} ${share}</div>
            </div>
            <div class="meta">‚òÅ</div>
          </div>
          <div class="actions">
            <button class="btn small" data-act="revoke">–û—Ç–æ–∑–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É</button>
            <button class="btn small" data-act="restrict">–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø (–∫–æ–º–∞–Ω–¥–∞)</button>
          </div>
        </div>
      `;
    }).join("");

    root.innerHTML = `
      <div class="section">
        <h2>–û–±–ª–∞–∫–æ</h2>
        <p>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: ¬´–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ–±—â–∏–µ —Å—Å—ã–ª–∫–∏. –ü—Ä–æ–≤–µ—Ä—å –ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º.¬ª</p>

        <div class="toggle">
          <input id="cloud_alerts" type="checkbox" ${c.cloudAlertsOn?"checked":""}/>
          <div>
            <div class="name">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–∞—Ö –∏ –Ω–æ–≤—ã—Ö —Å–µ—Å—Å–∏—è—Ö</div>
            <div class="meta">–ü–æ–º–æ–≥–∞—é—Ç –∑–∞–º–µ—Ç–∏—Ç—å –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—é.</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="name">–ü–∞–ø–∫–∏</div>
        <div class="list">${folderHtml}</div>

        <div class="hr"></div>
        <div class="row">
          <span class="badge ${c.cloudNoPublicLinks?"good":"warn"}" id="cloud_pub">‚Äî</span>
          <span class="badge ${c.cloudNoEveryone?"good":"warn"}" id="cloud_every">‚Äî</span>
        </div>
      </div>
    `;

    function recompute(){
      c.cloudNoPublicLinks = !sc.folders.some(f=>f.publicLink);
      c.cloudNoEveryone = !sc.folders.some(f=>f.share==="everyone");
      const b1 = root.querySelector("#cloud_pub");
      const b2 = root.querySelector("#cloud_every");
      b1.textContent = c.cloudNoPublicLinks ? "–ü—É–±–ª–∏—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–µ—Ç" : "–ï—Å—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏";
      b2.textContent = c.cloudNoEveryone ? "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ '–≤—Å–µ–º'" : "–ï—Å—Ç—å –¥–æ—Å—Ç—É–ø '–≤—Å–µ–º'";
      b1.className = "badge " + (c.cloudNoPublicLinks?"good":"warn");
      b2.className = "badge " + (c.cloudNoEveryone?"good":"warn");
    }
    recompute();

    root.querySelector("#cloud_alerts").addEventListener("change",(e)=>{
      c.cloudAlertsOn = e.target.checked;
      logEvent("–û–±–ª–∞–∫–æ", c.cloudAlertsOn?"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–∞—Ö –≤–∫–ª—é—á–µ–Ω—ã.":"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–∞—Ö –≤—ã–∫–ª—é—á–µ–Ω—ã.");
    });

    root.querySelectorAll("[data-fold]").forEach(card=>{
      const idx = Number(card.getAttribute("data-fold"));
      const fold = sc.folders[idx];
      card.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          if(act==="revoke"){
            if(fold.publicLink){ fold.publicLink=false; logEvent("–û–±–ª–∞–∫–æ", `–ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç–æ–∑–≤–∞–Ω–∞: ${fold.name}.`); }
            else logEvent("–û–±–ª–∞–∫–æ", `–ü—É–±–ª–∏—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–µ –±—ã–ª–æ: ${fold.name}.`);
          } else if(act==="restrict"){
            if(fold.share==="everyone"){ fold.share="team"; logEvent("–û–±–ª–∞–∫–æ", `–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –∫–æ–º–∞–Ω–¥–æ–π: ${fold.name}.`); }
            else logEvent("–û–±–ª–∞–∫–æ", `–î–æ—Å—Ç—É–ø —É–∂–µ –∫–æ–º–∞–Ω–¥–Ω—ã–π: ${fold.name}.`);
          }
          card.querySelector(".meta").innerHTML =
            `${fold.publicLink ? `<span class="badge bad">–ø—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞</span>` : `<span class="badge good">–±–µ–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫</span>`}
             ${fold.share==="everyone" ? `<span class="badge warn">–¥–æ—Å—Ç—É–ø: –≤—Å–µ–º</span>` : `<span class="badge good">–¥–æ—Å—Ç—É–ø: –∫–æ–º–∞–Ω–¥–∞</span>`}`;
          recompute();
        });
      });
    });

    return root;
  }

  function taskContent_social(){
    const c = game.checks;
    const sc = game.scenario;
    const root = document.createElement("div");
    root.innerHTML = `
      <div class="section">
        <h2>–°–æ—Ü—Å–µ—Ç–∏</h2>
        <p>–°–æ–æ–±—â–µ–Ω–∏–µ: ¬´–ú–Ω–µ –ø—Ä–∏—à—ë–ª –∑–∞–ø—Ä–æ—Å –æ—Ç '—Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏'. –ü—Ä–æ–≤–µ—Ä—å, –Ω–µ —Ñ–µ–π–∫ –ª–∏.¬ª</p>

        <div class="toggle">
          <input id="soc_public" type="checkbox" ${!c.socialPrivacyTight?"checked":""}/>
          <div>
            <div class="name">–ü—Ä–æ—Ñ–∏–ª—å –ø—É–±–ª–∏—á–Ω—ã–π</div>
            <div class="meta">–ü—É–±–ª–∏—á–Ω–æ—Å—Ç—å —É–ø—Ä–æ—â–∞–µ—Ç —Å–æ—Ü.–∏–Ω–∂–µ–Ω–µ—Ä–∏—é.</div>
          </div>
        </div>

        <div class="toggle">
          <input id="soc_dm" type="checkbox" ${!c.socialDmRestricted?"checked":""}/>
          <div>
            <div class="name">–õ–° —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤—Å–µ–º</div>
            <div class="meta">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–Ω–∏–∂–∞–µ—Ç –ø–æ—Ç–æ–∫ —Ñ–∏—à–∏–Ω–≥–∞/—Å–ø–∞–º–∞.</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="item">
          <div class="top">
            <div>
              <div class="name">${esc(sc.fakeAccount.name)} <span class="badge bad">–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π</span></div>
              <div class="meta">${esc(sc.fakeAccount.note)}</div>
            </div>
            <div class="meta">üë§</div>
          </div>
          <div class="actions">
            <button class="btn small bad" id="soc_block">${sc.fakeAccount.blocked?"–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω":"–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å"}</button>
            <button class="btn small" id="soc_report">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row">
          <span class="badge ${c.socialPrivacyTight?"good":"warn"}" id="soc_priv">${c.socialPrivacyTight?"–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å —É—Å–∏–ª–µ–Ω–∞":"–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å —Å–ª–∞–±–∞—è"}</span>
          <span class="badge ${c.socialDmRestricted?"good":"warn"}" id="soc_dm_badge">${c.socialDmRestricted?"–õ–° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã":"–õ–° –æ—Ç–∫—Ä—ã—Ç—ã –≤—Å–µ–º"}</span>
          <span class="badge ${c.socialFakeBlocked?"good":"warn"}" id="soc_fake">${c.socialFakeBlocked?"–§–µ–π–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω":"–§–µ–π–∫ –∞–∫—Ç–∏–≤–µ–Ω"}</span>
        </div>
      </div>
    `;

    const tPublic = root.querySelector("#soc_public");
    const tDm = root.querySelector("#soc_dm");
    const bPriv = root.querySelector("#soc_priv");
    const bDm = root.querySelector("#soc_dm_badge");
    const bFake = root.querySelector("#soc_fake");
    const btnBlock = root.querySelector("#soc_block");

    tPublic.addEventListener("change", ()=>{
      c.socialPrivacyTight = !tPublic.checked;
      bPriv.textContent = c.socialPrivacyTight?"–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å —É—Å–∏–ª–µ–Ω–∞":"–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å —Å–ª–∞–±–∞—è";
      bPriv.className = "badge "+(c.socialPrivacyTight?"good":"warn");
      logEvent("–°–æ—Ü—Å–µ—Ç–∏", c.socialPrivacyTight?"–ü—Ä–æ—Ñ–∏–ª—å —Å–¥–µ–ª–∞–Ω –º–µ–Ω–µ–µ –ø—É–±–ª–∏—á–Ω—ã–º.":"–ü—Ä–æ—Ñ–∏–ª—å –æ—Å—Ç–∞–≤–ª–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–º.");
    });
    tDm.addEventListener("change", ()=>{
      c.socialDmRestricted = !tDm.checked;
      bDm.textContent = c.socialDmRestricted?"–õ–° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã":"–õ–° –æ—Ç–∫—Ä—ã—Ç—ã –≤—Å–µ–º";
      bDm.className = "badge "+(c.socialDmRestricted?"good":"warn");
      logEvent("–°–æ—Ü—Å–µ—Ç–∏", c.socialDmRestricted?"–õ–° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã.":"–õ–° —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤—Å–µ–º.");
    });
    btnBlock.addEventListener("click", ()=>{
      sc.fakeAccount.blocked = true;
      c.socialFakeBlocked = true;
      btnBlock.textContent="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω";
      btnBlock.disabled=true;
      bFake.textContent="–§–µ–π–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω";
      bFake.className="badge good";
      logEvent("–°–æ—Ü—Å–µ—Ç–∏","–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.");
    });
    root.querySelector("#soc_report").addEventListener("click", ()=>logEvent("–°–æ—Ü—Å–µ—Ç–∏","–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç."));

    return root;
  }

  function taskContent_home(){
    const root = document.createElement("div");
    root.innerHTML = `
      <div class="section">
        <h2>–í—ã—Ö–æ–¥ ‚Äî —É–π—Ç–∏ –¥–æ–º–æ–π</h2>
        <p>–ù–æ—á—å —Å–º–æ–¥–µ–ª–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è. –ï—Å–ª–∏ –µ—Å—Ç—å –¥—ã—Ä—ã ‚Äî –æ–Ω–∏ ¬´–≤—Å–ø–ª—ã–≤—É—Ç¬ª.</p>
        <div class="row">
          <button class="btn good" id="go_home">–£–π—Ç–∏ –¥–æ–º–æ–π ‚Üí –Ω–æ—á–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è</button>
          <button class="btn" id="go_back">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
        </div>
        <div class="hr"></div>
        <div class="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞ —É –¥–≤–µ—Ä–∏: ¬´–ü–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º ‚Äî —Ñ–∏–∑–∏–∫–∞, —É—á—ë—Ç–∫–∏, –ø–æ—á—Ç–∞, —Å–µ—Ç—å, –æ–±–ª–∞–∫–æ, —Å–æ—Ü—Å–µ—Ç–∏¬ª.</div>
      </div>
    `;
    root.querySelector("#go_back").addEventListener("click", closeTerminal);
    root.querySelector("#go_home").addEventListener("click", ()=>{ closeTerminal(); night(); });
    return root;
  }

  function buildTaskUI(id){
    if(id==="workstation") return taskContent_workstation();
    if(id==="accounts") return taskContent_accounts();
    if(id==="mail") return taskContent_mail();
    if(id==="network") return taskContent_network();
    if(id==="cloud") return taskContent_cloud();
    if(id==="social") return taskContent_social();
    if(id==="home") return taskContent_home();
    const d = document.createElement("div");
    d.innerHTML = `<div class="section"><h2>‚Äî</h2><p>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª.</p></div>`;
    return d;
  }

  // ---------- Night / Report ----------
  function addItem(listEl, title, meta, right=""){
    const it = document.createElement("div");
    it.className="item";
    it.innerHTML = `<div class="top"><div><div class="name">${esc(title)}</div><div class="meta">${esc(meta)}</div></div><div class="meta">${esc(right)}</div></div>`;
    listEl.appendChild(it);
  }

  function night(){
    // derive
    const c = game.checks;
    c.passwordStrongUnique = c.passwordChanged && c.passwordStrong && c.passwordUnique;
    c.networkSafe = c.unknownDeviceRemoved && c.guestWifiOff && c.firmwareUpdated;
    c.cloudSafe = c.cloudNoPublicLinks && c.cloudNoEveryone && c.cloudAlertsOn;
    c.socialSafe = c.socialPrivacyTight && c.socialFakeBlocked && c.socialDmRestricted;

    const errors = [];
    const addPenalty = (key)=>{ const p=PENALTIES[key]; if(p) errors.push({key, pts:p.pts, msg:p.msg}); };

    // workstation
    if(!c.workstationLocked) addPenalty("workstation_unlocked");
    if(!c.usbRemoved) addPenalty("usb_left");
    if(!c.updatesOn) addPenalty("updates_off");
    if(!c.avRun) addPenalty("av_not_run");

    // accounts
    if(!c.twoFAOn) addPenalty("twoFA_off");
    if(!c.passwordChanged) addPenalty("default_password");
    else{
      if(!c.passwordStrong) addPenalty("weak_password");
      if(!c.passwordUnique) addPenalty("reused_password");
    }
    if(!c.browserPwOff) addPenalty("browser_pw_on");

    // mail
    if(!c.phishingSafe || c.phishingOpened>0) addPenalty("phishing_open");

    // network
    if(!c.unknownDeviceRemoved) addPenalty("unknown_device");
    if(!c.guestWifiOff) addPenalty("guest_wifi_on");
    if(!c.firmwareUpdated) addPenalty("firmware_old");

    // cloud
    if(!c.cloudNoPublicLinks) addPenalty("cloud_public");
    if(!c.cloudNoEveryone) addPenalty("cloud_everyone");
    if(!c.cloudAlertsOn) addPenalty("cloud_alerts_off");

    // social
    if(!c.socialPrivacyTight) addPenalty("social_public");
    if(!c.socialFakeBlocked) addPenalty("social_fake_not_blocked");
    if(!c.socialDmRestricted) addPenalty("social_dm_open");

    // hints
    for(let i=0;i<game.hintsUsed;i++) addPenalty("hint_used");

    const penaltySum = errors.reduce((s,e)=>s+e.pts,0);
    const finalScore = clamp(100 - penaltySum, 0, 100);

    const missing = [];
    const map = {
      workstationLocked:"–ü–ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω",
      usbRemoved:"USB –∏–∑–≤–ª–µ—á—ë–Ω",
      updatesOn:"–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã",
      twoFAOn:"2FA –≤–∫–ª—é—á–µ–Ω–∞",
      passwordStrongUnique:"–ü–∞—Ä–æ–ª—å: —Å–∏–ª—å–Ω—ã–π –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π",
      browserPwOff:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤—ã–∫–ª—é—á–µ–Ω–æ",
      phishingSafe:"–ü–æ—á—Ç–∞: —Ñ–∏—à–∏–Ω–≥ –Ω–µ –æ—Ç–∫—Ä—ã—Ç",
      networkSafe:"–°–µ—Ç—å: –±–µ–∑–æ–ø–∞—Å–Ω–∞",
      cloudSafe:"–û–±–ª–∞–∫–æ: –±–µ–∑–æ–ø–∞—Å–Ω–æ",
      socialSafe:"–°–æ—Ü—Å–µ—Ç–∏: –±–µ–∑–æ–ø–∞—Å–Ω—ã"
    };
    for(const k of CRITICAL){
      if(!c[k]) missing.push(map[k]||k);
    }
    const win = missing.length===0;

    const incidents = [];
    if(!c.workstationLocked || !c.usbRemoved || !c.updatesOn) incidents.push("–ù–æ—á—å—é –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –∫ —Ä–∞–±–æ—á–µ–π —Å—Ç–∞–Ω—Ü–∏–∏/–Ω–æ—Å–∏—Ç–µ–ª—é –∏ –≤—ã–≥—Ä—É–∑–∏–ª —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.");
    if(!c.passwordStrongUnique || !c.twoFAOn || !c.browserPwOff) incidents.push("–ù–æ—á—å—é —É—á—ë—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –±—ã–ª–∞ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ —Å–ª–∞–±—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é.");
    if(!c.phishingSafe) incidents.push("–ù–æ—á—å—é —Å—Ä–∞–±–æ—Ç–∞–ª–∞ —Ü–µ–ø–æ—á–∫–∞ –∑–∞—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ø–æ—á—Ç—É (–≤—Ä–µ–¥–æ–Ω–æ—Å –∑–∞–∫—Ä–µ–ø–∏–ª—Å—è).");
    if(!c.networkSafe) incidents.push("–ù–æ—á—å—é –∞—Ç–∞–∫–∞ –ø—Ä–∏—à–ª–∞ –∏–∑–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏ —á–µ—Ä–µ–∑ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ/–≥–æ—Å—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø/—É—è–∑–≤–∏–º—É—é –ø—Ä–æ—à–∏–≤–∫—É.");
    if(!c.cloudSafe) incidents.push("–ù–æ—á—å—é –¥–æ–∫—É–º–µ–Ω—Ç—ã —É—Ç–µ–∫–ª–∏ —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–µ –ø—Ä–∞–≤–∞.");
    if(!c.socialSafe) incidents.push("–ù–æ—á—å—é –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Å–æ—Ü–∏–Ω–∂–µ–Ω–µ—Ä–∏—è —á–µ—Ä–µ–∑ —Å–æ—Ü—Å–µ—Ç–∏ (—Ñ–µ–π–∫/–ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å/–õ–°).");
    if(!incidents.length) incidents.push("–ù–æ—á—å –ø—Ä–æ—à–ª–∞ —Å–ø–æ–∫–æ–π–Ω–æ: —Ç—Ä–µ–≤–æ–≥ –∏ —É—Ç–µ—á–µ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.");

    // Report UI
    el.repTitle.textContent = win ? "–ü–æ–±–µ–¥–∞ ‚Äî –Ω–æ—á—å –±–µ–∑ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞" : "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ ‚Äî –Ω–æ—á–Ω–æ–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç";
    el.repSub.textContent = win
      ? "–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã. –û—Ñ–∏—Å –≤—ã–¥–µ—Ä–∂–∞–ª –Ω–æ—á–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É."
      : "–ù–µ –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–µ—Ä—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã. –ù–æ—á—å –ø–æ–∫–∞–∑–∞–ª–∞ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è (–±–µ–∑ –¥–µ—Ç–∞–ª–µ–π).";

    el.repPct.textContent = `–ò—Ç–æ–≥: ${finalScore}%`;
    el.repPct.className = "badge "+(finalScore>=85?"good":finalScore>=60?"warn":"bad");
    el.repVerdict.textContent = win ? "–°—Ç–∞—Ç—É—Å: OK" : "–°—Ç–∞—Ç—É—Å: INCIDENT";
    el.repVerdict.className = "badge "+(win?"good":"bad");

    const spent = game.dayLen - game.timeLeft;
    el.repTime.textContent = `–í—Ä–µ–º—è: ${fmtTime(spent)} / ${fmtTime(game.dayLen)}`;

    el.repSummary.innerHTML="";
    addItem(el.repSummary, "–ù–æ—á–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è", incidents.join(" "));
    if(!win) addItem(el.repSummary, "–ö—Ä–∏—Ç–∏—á–Ω–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ", missing.join(" ¬∑ "), "‚ö†");
    else addItem(el.repSummary, "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏", "–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ä—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.", "‚úì");

    const errBox = document.createElement("div");
    errBox.className="item";
    const sorted = errors.sort((a,b)=>b.pts-a.pts);
    errBox.innerHTML = `<div class="name">–®—Ç—Ä–∞—Ñ—ã</div><div class="meta" style="margin-top:6px">${sorted.length?sorted.map(e=>`‚àí${e.pts}% ‚Äî ${esc(e.msg)}`).join("<br/>"):"–û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."}</div>`;
    el.repSummary.appendChild(errBox);

    el.repRecs.innerHTML="";
    const recs=[];
    if(!c.workstationLocked) recs.push("–ü–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º –±–ª–æ–∫–∏—Ä—É–π —Å–µ—Å—Å–∏—é (Win+L).");
    if(!c.usbRemoved) recs.push("–ù–µ –æ—Å—Ç–∞–≤–ª—è–π –Ω–æ—Å–∏—Ç–µ–ª–∏ –≤ –ü–ö.");
    if(!c.updatesOn) recs.push("–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –û–°/–ü–û –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω—ã.");
    if(!c.twoFAOn) recs.push("–í–∫–ª—é—á–∞–π 2FA –Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —É—á—ë—Ç–∫–∞—Ö.");
    if(!c.passwordStrongUnique) recs.push("–°–∏–ª—å–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤.");
    if(!c.browserPwOff) recs.push("–û—Ç–∫–ª—é—á–∞–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä).");
    if(!c.phishingSafe) recs.push("–ü–æ—á—Ç—É –ø—Ä–æ–≤–µ—Ä—è–π –ø–æ –¥–æ–º–µ–Ω–∞–º/—Å—Ä–æ—á–Ω–æ—Å—Ç–∏/–≤–ª–æ–∂–µ–Ω–∏—è–º. –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ ‚Äî —Å–æ–æ–±—â–∞–π, –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—è.");
    if(!c.networkSafe) recs.push("–û—Ç–∫–ª—é—á–∞–π –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –≤—ã–∫–ª—é—á–∞–π –≥–æ—Å—Ç–µ–≤–æ–π Wi-Fi, –æ–±–Ω–æ–≤–ª—è–π —Ä–æ—É—Ç–µ—Ä.");
    if(!c.cloudSafe) recs.push("–ó–∞–∫—Ä—ã–≤–∞–π –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏, —É–±–∏—Ä–∞–π –¥–æ—Å—Ç—É–ø ¬´–≤—Å–µ–º¬ª, –≤–∫–ª—é—á–∞–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–∞—Ö.");
    if(!c.socialSafe) recs.push("–°–Ω–∏–∂—É–π –ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π –õ–°, –±–ª–æ–∫–∏—Ä—É–π —Ñ–µ–π–∫–∏.");
    if(game.hintsUsed>0) recs.push("–≠–∫–æ–Ω–æ–º—å –ø–æ–¥—Å–∫–∞–∑–∫–∏: –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è –Ω–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è.");

    if(!recs.length) recs.push("–ü—Ä–æ–¥–æ–ª–∂–∞–π —Ç–∞–∫ –∂–µ: –¥–µ–π—Å—Ç–≤–∏—è —É—Å—Ç–æ–π—á–∏–≤—ã –∫ –Ω–æ—á–Ω—ã–º —Å—Ü–µ–Ω–∞—Ä–∏—è–º.");
    for(const r of recs) addItem(el.repRecs, "‚Ä¢", r);

    el.repLog.innerHTML="";
    const logItems = game.logs.slice(-120);
    if(!logItems.length) addItem(el.repLog, "–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç", "‚Äî");
    else for(const e of logItems) addItem(el.repLog, e.title, e.detail, e.ts);

    setState(State.REPORT);
  }

  el.btnRestart.addEventListener("click", ()=>location.reload());

  // ---------- Main Loop ----------
  let lastT = 0;

  function update(dt){
    if(game.state===State.PLAY){
      // timer
      game.timeLeft -= dt;
      if(game.timeLeft<=0){
        game.timeLeft=0;
        logEvent("–í—Ä–µ–º—è","–°–º–µ–Ω–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å. –ù–æ—á—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.");
        night();
        return;
      }

      // movement
      const p = world.player;
      let ax=0, ay=0;
      if(keys.has("KeyW")||keys.has("ArrowUp")) ay -= 1;
      if(keys.has("KeyS")||keys.has("ArrowDown")) ay += 1;
      if(keys.has("KeyA")||keys.has("ArrowLeft")) ax -= 1;
      if(keys.has("KeyD")||keys.has("ArrowRight")) ax += 1;

      const len = Math.hypot(ax,ay)||1;
      ax/=len; ay/=len;

      const speed = p.speed;
      const accel = 18.0;
      const friction = 10.0;

      const wx = ax*speed, wy = ay*speed;
      p.vx += (wx - p.vx) * clamp(dt*accel,0,1);
      p.vy += (wy - p.vy) * clamp(dt*accel,0,1);
      if(ax===0 && ay===0){
        p.vx -= p.vx * clamp(dt*friction,0,1);
        p.vy -= p.vy * clamp(dt*friction,0,1);
      }

      p.x = clamp(p.x + p.vx*dt, 0.8, world.w-0.8);
      p.y = clamp(p.y + p.vy*dt, 0.8, world.h-0.8);

      // hover prompt
      const o = nearestInteractable();
      world.hover = o;
      if(o){
        showPrompt(true, "E: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å", o.name);
      } else {
        showPrompt(false);
      }

      // ambient hints (soft)
      if(Math.random() < dt * 0.08){
        const z = zoneFromPos(p.x,p.y);
        const c = game.checks;
        const pool=[];
        if(z==="–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ" && (!c.workstationLocked || !c.usbRemoved || !c.updatesOn)) pool.push(["–°—Ç–∏–∫–µ—Ä","–ù–∞ —Å—Ç–æ–ª–µ –∑–∞–º–µ—Ç–∫–∞ –ø—Ä–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É, –Ω–æ—Å–∏—Ç–µ–ª–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è."]);
        if(z==="–£—á—ë—Ç–∫–∏ –∏ –ø–∞—Ä–æ–ª–∏" && (!c.twoFAOn || !c.passwordChanged || !c.browserPwOff)) pool.push(["–ß–∞—Ç","¬´–ü—Ä–æ–≤–µ—Ä—å 2FA –∏ —á—Ç–æ –ø–∞—Ä–æ–ª—å –Ω–µ 'Welcome123'¬ª"]);
        if(z==="–ü–æ—á—Ç–∞" && c.phishingReported===0) pool.push(["–ü–æ—á—Ç–∞","–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–∏—Å—å–º–∞ –≤—ã–≥–ª—è–¥—è—Ç ¬´—Å–ª–∏—à–∫–æ–º —Å—Ä–æ—á–Ω–æ¬ª."]);
        if(z==="–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç—å" && (!c.firmwareUpdated || !c.unknownDeviceRemoved)) pool.push(["–°–µ—Ç—å","–ú–∏–≥–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä ¬´–Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ¬ª/¬´–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ¬ª."]);
        if(z==="–û–±–ª–∞–∫–æ" && (!c.cloudNoPublicLinks || !c.cloudNoEveryone || !c.cloudAlertsOn)) pool.push(["–û–±–ª–∞–∫–æ","–ü–∞–Ω–µ–ª—å –Ω–∞–º–µ–∫–∞–µ—Ç –Ω–∞ –æ–±—â–∏–µ —Å—Å—ã–ª–∫–∏ –∏ —à–∏—Ä–æ–∫–∏–µ –ø—Ä–∞–≤–∞."]);
        if(z==="–°–æ—Ü—Å–µ—Ç–∏" && (!c.socialFakeBlocked || !c.socialPrivacyTight)) pool.push(["–°–æ—Ü—Å–µ—Ç–∏","–í–∏–¥–µ–Ω –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É."]);
        if(pool.length){
          const [t,d]=choice(pool);
          logEvent(t,d);
        }
      }
    }

    // draw every frame for simplicity
    draw();
    updateHUD();
  }

  function loop(t){
    if(!lastT) lastT = t;
    const dt = clamp((t-lastT)/1000, 0, 0.05);
    lastT = t;

    // slower time while reading terminal/phone (pressure but softer)
    if(game.state===State.PHONE || game.state===State.TERM){
      game.timeLeft -= dt * 0.75;
      if(game.timeLeft<=0 && game.state!==State.REPORT){
        game.timeLeft=0;
        night();
        return;
      }
      draw();
      updateHUD();
      requestAnimationFrame(loop);
      return;
    }

    if(game.state===State.PAUSE){
      draw();
      updateHUD();
      requestAnimationFrame(loop);
      return;
    }

    if(game.state===State.REPORT || game.state===State.MENU){
      draw();
      updateHUD();
      requestAnimationFrame(loop);
      return;
    }

    update(dt);
    requestAnimationFrame(loop);
  }

  // ---------- Boot / Start ----------
  function resetGame(){
    game.timeLeft = game.dayLen;
    game.score = 100;
    game.hintsLeft = 3;
    game.hintsUsed = 0;
    game.logs = [];
    game.scenario = buildScenario();
    for(const k of Object.keys(game.checks)){
      if(typeof game.checks[k]==="boolean") game.checks[k]=false;
      if(k==="phishingSafe") game.checks[k]=true;
      if(k==="phishingReported") game.checks[k]=0;
      if(k==="phishingOpened") game.checks[k]=0;
    }
    // cloud derived (based on scenario) will update in terminal; set to false now
    resetObjects();
    renderLogList();
    el.hintText.textContent = "‚Äî";
    setTab("help");
  }

  function start(){
    resetGame();
    setState(State.PLAY);
    logEvent("–°—Ç–∞—Ä—Ç","–°–º–µ–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å. –û—Å–º–æ—Ç—Ä–∏—Å—å –ø–æ –∑–æ–Ω–∞–º –∏ —É–±–µ—Ä–∏ —Ä–∏—Å–∫–∏.");
  }

  el.btnStart.addEventListener("click", start);

  // Cloud derived flags should recompute when cloud terminal opens; for report we need it correct:
  // We'll recompute whenever leaving cloud UI is possible, but easiest: compute on-demand in report/night().
  // (Already computed there.)

  // Phone close on background click: optional (not required)
  el.phone.addEventListener("click",(e)=>{ if(e.target===el.phone) setState(State.PLAY); });
  el.terminal.addEventListener("click",(e)=>{ if(e.target===el.terminal) closeTerminal(); });

  // Init
  resize();
  updateHUD();
  requestAnimationFrame(loop);

})();
</script>

<!--
–ó–∞–ø—É—Å–∫: –æ—Ç–∫—Ä–æ–π index.html –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º.
–ö–ª–∞–≤–∏—à–∏:
- WASD / —Å—Ç—Ä–µ–ª–∫–∏ ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ
- E ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª –æ–±—ä–µ–∫—Ç–∞ —Ä—è–¥–æ–º)
- Tab ‚Äî —Å–º–∞—Ä—Ç—Ñ–æ–Ω (–ø–æ–º–æ—â—å/–∂—É—Ä–Ω–∞–ª/–ø–æ–¥—Å–∫–∞–∑–∫–∞)
- Esc ‚Äî –∑–∞–∫—Ä—ã—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª/—Å–º–∞—Ä—Ç—Ñ–æ–Ω, –ø–∞—É–∑–∞/–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
-->
</body>
</html>
