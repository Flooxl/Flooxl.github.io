<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>REMEMBER ME ‚Äî Office Night Incident (Pixel 3D)</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1722ee;
      --panel2:#0f1722cc;
      --text:#e8eef7;
      --muted:#a8b3c5;
      --accent:#4de3a8;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --good:#55ff99;
      --line:#263449;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow:hidden;}
    #root{position:fixed; inset:0; display:flex; align-items:stretch; justify-content:stretch;}
    #gameWrap{position:relative; flex:1; overflow:hidden;}
    canvas{display:block; width:100%; height:100%;}
    /* Pixelated upscale */
    #threeCanvas, #fallbackCanvas{
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    /* HUD */
    #hud{
      position:absolute; inset:0; pointer-events:none;
      display:flex; flex-direction:column; justify-content:space-between;
      padding:12px;
    }
    #topBar{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .chip{
      pointer-events:none;
      background: linear-gradient(180deg, #0f1722cc, #0f1722aa);
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      max-width: 52vw;
    }
    .chipRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .kv{display:flex; gap:8px; align-items:baseline;}
    .k{color:var(--muted);}
    .v{font-weight:700;}
    .badge{padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted);}
    .badge.good{color:var(--good); border-color:#2d7a58;}
    .badge.bad{color:var(--bad); border-color:#7a2d2d;}
    .badge.warn{color:var(--warn); border-color:#7a652d;}

    #centerPrompt{
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%);
      pointer-events:none;
      text-align:center;
      text-shadow: 0 2px 10px rgba(0,0,0,.6);
      opacity:.0;
      transition: opacity .12s ease;
    }
    #centerPrompt .big{font-weight:800; font-size:16px;}
    #centerPrompt .small{color:var(--muted); margin-top:3px; font-size:12px;}
    #crosshair{
      position:absolute; left:50%; top:50%;
      width:10px; height:10px; transform:translate(-50%,-50%);
      pointer-events:none;
      opacity:.75;
    }
    #crosshair:before, #crosshair:after{
      content:""; position:absolute; left:50%; top:50%;
      background: rgba(232,238,247,.85);
      transform: translate(-50%,-50%);
      border-radius:1px;
    }
    #crosshair:before{width:10px; height:2px;}
    #crosshair:after{width:2px; height:10px;}

    #logToast{
      position:absolute; left:12px; bottom:12px;
      width:min(520px, 70vw);
      pointer-events:none;
      display:flex; flex-direction:column; gap:8px;
    }
    .toast{
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:12px;
      padding:9px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      opacity:0;
      transform: translateY(8px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform: translateY(0);}
    .toast .t{font-weight:700;}
    .toast .d{color:var(--muted); margin-top:2px; font-size:12px;}

    /* Overlays */
    #overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 800px at 50% 40%, rgba(13,20,31,.75), rgba(4,6,10,.92));
      backdrop-filter: blur(6px);
      z-index:10;
    }
    #overlay.hidden{display:none;}
    .panel{
      width:min(920px, 92vw);
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .panel h1{margin:0 0 8px 0; font-size:18px;}
    .panel p{margin:8px 0; color:var(--muted);}
    .panel .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:12px;}
    .btn{
      pointer-events:auto;
      border:1px solid var(--line);
      background: #0d1520;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      font-weight:700;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
    }
    .btn:hover{border-color:#375072;}
    .btn:active{transform: translateY(1px);}
    .btn.primary{background: linear-gradient(180deg, #173253, #0d1520); border-color:#355a86;}
    .btn.good{background: linear-gradient(180deg, #133527, #0d1520); border-color:#2d7a58;}
    .btn.bad{background: linear-gradient(180deg, #3b1c1c, #0d1520); border-color:#7a2d2d;}
    .btn.small{padding:8px 10px; font-weight:700;}
    .hint{color:var(--muted); font-size:12px;}
    .grid2{display:grid; grid-template-columns: 1.2fr .8fr; gap:12px;}
    @media (max-width:860px){ .grid2{grid-template-columns:1fr; } }

    /* Phone/Task UI */
    #phone{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.55);
      z-index:9;
      pointer-events:auto;
    }
    #phone.show{display:flex;}
    #phoneCard{
      width:min(860px, 94vw);
      max-height: min(86vh, 780px);
      overflow:auto;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    #phoneHeader{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      position:sticky; top:0;
      background: linear-gradient(180deg, rgba(15,23,34,1), rgba(15,23,34,.9));
      border-bottom:1px solid var(--line);
      margin:-14px -14px 12px -14px;
      padding:12px 14px;
      border-radius:16px 16px 0 0;
      z-index:1;
    }
    #phoneHeader .title{font-weight:900;}
    #tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tab{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      user-select:none;
      background:#0d1520;
      color:var(--muted);
      font-weight:800;
    }
    .tab.active{color:var(--text); border-color:#375072; background:#0f1b2a;}
    .section{border:1px solid var(--line); border-radius:14px; padding:12px; margin-bottom:12px; background:#0c121b;}
    .section h2{margin:0 0 8px 0; font-size:14px;}
    .section p{margin:6px 0; color:var(--muted);}
    .rowLine{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .field{display:flex; flex-direction:column; gap:6px; margin:8px 0;}
    .field label{color:var(--muted); font-size:12px;}
    input[type="text"], input[type="password"], select{
      background:#0b111a; color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    .toggle{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      background:#0b111a;
      margin:8px 0;
    }
    .toggle input{transform: scale(1.15);}
    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px;}
    .item{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#0b111a;
    }
    .item .top{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .item .name{font-weight:900;}
    .item .meta{color:var(--muted); font-size:12px;}
    .item .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    .hr{height:1px; background: var(--line); margin:10px 0;}

    /* Pause overlay indicator */
    #pausedTag{
      position:absolute; right:12px; bottom:12px;
      pointer-events:none;
      opacity:0;
      transition: opacity .15s ease;
    }
    #pausedTag.show{opacity:1;}
  </style>
</head>
<body>
<div id="root">
  <div id="gameWrap">
    <canvas id="threeCanvas"></canvas>
    <canvas id="fallbackCanvas" style="display:none"></canvas>

    <div id="hud">
      <div id="topBar">
        <div class="chip">
          <div class="chipRow">
            <div class="kv"><span class="k">–î–µ–Ω—å:</span><span class="v" id="dayName">–û—Ñ–∏—Å–Ω–∞—è —Å–º–µ–Ω–∞</span></div>
            <span class="badge warn" id="timeBadge">‚è≥ 08:00</span>
            <span class="badge" id="hintBadge">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏: 3</span>
          </div>
          <div class="hint" id="softGoal">–¶–µ–ª—å: –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å—Ä–µ–¥—É —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–æ—á—å—é –Ω–µ —Å–ª—É—á–∏–ª—Å—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç. –ß–µ–∫–ª–∏—Å—Ç–∞ –Ω–µ –±—É–¥–µ—Ç.</div>
        </div>

        <div class="chip">
          <div class="chipRow">
            <span class="badge" id="renderBadge">Renderer: ...</span>
            <span class="badge" id="zoneBadge">–ó–æ–Ω–∞: ‚Äî</span>
            <span class="badge" id="lockBadge">üîì –ú—ã—à—å: —Å–≤–æ–±–æ–¥–Ω–∞</span>
          </div>
          <div class="hint">WASD/—Å—Ç—Ä–µ–ª–∫–∏ ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ ¬∑ –º—ã—à—å ‚Äî –æ–±–∑–æ—Ä ¬∑ E ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å ¬∑ Tab ‚Äî —Å–º–∞—Ä—Ç—Ñ–æ–Ω ¬∑ Esc ‚Äî –ø–∞—É–∑–∞/–≤—ã—Ö–æ–¥</div>
        </div>
      </div>

      <div id="centerPrompt">
        <div class="big" id="promptBig">E: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å</div>
        <div class="small" id="promptSmall">...</div>
      </div>

      <div id="crosshair"></div>

      <div id="logToast"></div>
      <div id="pausedTag" class="chip"><span class="badge warn">–ü–∞—É–∑–∞</span> <span class="hint">Esc ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</span></div>
    </div>

    <div id="phone">
      <div id="phoneCard">
        <div id="phoneHeader">
          <div>
            <div class="title">–°–º–∞—Ä—Ç—Ñ–æ–Ω</div>
            <div class="hint">–ó–¥–µ—Å—å –Ω–µ—Ç —Å–ø–∏—Å–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á. –ï—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –∂—É—Ä–Ω–∞–ª.</div>
          </div>
          <div class="rowLine">
            <div id="tabs">
              <div class="tab active" data-tab="help">–ü–æ–º–æ—â—å</div>
              <div class="tab" data-tab="log">–ñ—É—Ä–Ω–∞–ª</div>
              <div class="tab" data-tab="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
            </div>
            <button class="btn small" id="btnClosePhone">–ó–∞–∫—Ä—ã—Ç—å (Tab)</button>
          </div>
        </div>

        <div id="tab_help" class="tabBody">
          <div class="section">
            <h2>–û—Ä–∏–µ–Ω—Ç–∏—Ä—ã</h2>
            <p>–í –æ—Ñ–∏—Å–µ –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–µ —Ç–µ—Ä–º–∏–Ω–∞–ª—ã –ø–æ –∑–æ–Ω–∞–º. –£ –∫–∞–∂–¥–æ–π –∑–æ–Ω—ã –µ—Å—Ç—å ¬´–æ–±—ã—á–Ω–∞—è —Ä—É—Ç–∏–Ω–∞¬ª, –Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –º–µ–ª–æ—á–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã –Ω–æ—á—å—é.</p>
            <p>–ü—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã: —Å—Ç–∏–∫–µ—Ä—ã, –º–∏–≥–∞—é—â–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞—Ö, —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–ª–ª–µ–≥.</p>
          </div>
          <div class="section">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <div class="rowLine">
              <span class="badge">WASD / —Å—Ç—Ä–µ–ª–∫–∏</span>
              <span class="badge">–ú—ã—à—å ‚Äî –æ–±–∑–æ—Ä (Pointer Lock)</span>
              <span class="badge">E ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ</span>
              <span class="badge">Tab ‚Äî —Å–º–∞—Ä—Ç—Ñ–æ–Ω</span>
              <span class="badge">Esc ‚Äî –ø–∞—É–∑–∞/–≤—ã—Ö–æ–¥</span>
            </div>
          </div>
          <div class="section">
            <h2>–ü–∏–∫—Å–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º</h2>
            <p>–†–µ–Ω–¥–µ—Ä –∏–¥—ë—Ç –≤ –Ω–∏–∑–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏ —Å –∞–ø—Å–∫–µ–π–ª–æ–º. –ú–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å/—É–≤–µ–ª–∏—á–∏—Ç—å –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—é.</p>
            <div class="rowLine">
              <button class="btn small" id="btnPixMinus">‚àí –ü–∏–∫—Å–µ–ª–∏</button>
              <button class="btn small" id="btnPixPlus">+ –ü–∏–∫—Å–µ–ª–∏</button>
              <span class="hint" id="pixInfo">scale: ‚Ä¶</span>
            </div>
          </div>
        </div>

        <div id="tab_log" class="tabBody" style="display:none">
          <div class="section">
            <h2>–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h2>
            <div class="hint">–§–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –Ω–æ—á—å—é.</div>
            <div class="hr"></div>
            <div id="logList" class="list"></div>
          </div>
        </div>

        <div id="tab_hint" class="tabBody" style="display:none">
          <div class="section">
            <h2>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏</h2>
            <p>–ü–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á. –û–Ω–∏ —Ç–æ–ª—å–∫–æ –Ω–∞–º–µ–∫–∞—é—Ç, –≥–¥–µ ¬´—Ç–æ–Ω–∫–æ¬ª. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–Ω–∏–∂–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π %.</p>
            <div class="rowLine">
              <button class="btn small primary" id="btnUseHint">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É</button>
              <span class="badge" id="hintLeft2">–û—Å—Ç–∞–ª–æ—Å—å: 3</span>
              <span class="badge warn">–®—Ç—Ä–∞—Ñ: ‚àí2% –∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫—É</span>
            </div>
            <div class="hr"></div>
            <div class="item">
              <div class="name">–¢–µ–∫—É—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞</div>
              <div class="meta" id="hintText">‚Äî</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div id="overlay">
      <div class="panel">
        <h1>REMEMBER ME ‚Äî –æ—Ñ–∏—Å–Ω–∞—è —Å–º–µ–Ω–∞</h1>
        <p>–¢—ã —Å—Ç–∞–∂—ë—Ä-–∞–Ω–∞–ª–∏—Ç–∏–∫. –î–Ω—ë–º –≤—Å—ë –≤—ã–≥–ª—è–¥–∏—Ç –æ–±—ã—á–Ω–æ, –Ω–æ –Ω–æ—á—å—é –ª—é–±—ã–µ –Ω–µ–¥–æ—á—ë—Ç—ã –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –∏–Ω—Ü–∏–¥–µ–Ω—Ç.</p>
        <p>–û—Å–º–∞—Ç—Ä–∏–≤–∞–π –∑–æ–Ω—ã, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–π —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º–∏, –¥–µ–ª–∞–π —Ä–∞–∑—É–º–Ω—ã–µ –º–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
        <p>–ö–æ–≥–¥–∞ —Ä–µ—à–∏—à—å, —á—Ç–æ –≤—Å—ë –≥–æ—Ç–æ–≤–æ ‚Äî –Ω–∞–∂–º–∏ ¬´–£–π—Ç–∏ –¥–æ–º–æ–π¬ª. –ù–æ—á—å –ø—Ä–æ–≤–µ—Ä–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>
        <div class="row">
          <button class="btn primary" id="btnStart">–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É</button>
          <button class="btn" id="btnLockMouse">–ó–∞—Ö–≤–∞—Ç–∏—Ç—å –º—ã—à—å (Pointer Lock)</button>
          <span class="hint">–û—Ç–∫—Ä—ã–≤–∞—Ç—å —Ñ–∞–π–ª –º–æ–∂–Ω–æ –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.</span>
        </div>
        <div class="row">
          <span class="badge warn">–¢–∞–π–º–µ—Ä: 8 –º–∏–Ω—É—Ç</span>
          <span class="badge">–ü–æ–¥—Å–∫–∞–∑–∫–∏: 3 (—à—Ç—Ä–∞—Ñ –∫ %)</span>
          <span class="badge">–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –º–µ—Ä—ã ‚Üí –Ω–æ—á–Ω–æ–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç</span>
        </div>
      </div>
    </div>

    <div id="report" style="display:none; position:absolute; inset:0; z-index:11; background:rgba(0,0,0,.72); backdrop-filter:blur(6px); pointer-events:auto; overflow:auto;">
      <div class="panel" style="margin:18px auto; width:min(980px,94vw);">
        <h1 id="reportTitle">–û—Ç—á—ë—Ç</h1>
        <p id="reportSubtitle" class="hint"></p>
        <div class="grid2">
          <div class="section">
            <h2>–ò—Ç–æ–≥</h2>
            <div class="rowLine" style="margin-top:8px">
              <span class="badge" id="finalPct">‚Äî%</span>
              <span class="badge" id="finalVerdict">‚Äî</span>
              <span class="badge warn" id="finalTime">‚Äî</span>
            </div>
            <div class="hr"></div>
            <div id="finalSummary" class="list"></div>
          </div>
          <div class="section">
            <h2>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
            <div id="finalRecs" class="list"></div>
            <div class="hr"></div>
            <button class="btn primary" id="btnRestart">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
          </div>
        </div>
        <div class="section">
          <h2>–ñ—É—Ä–Ω–∞–ª</h2>
          <div id="finalLog" class="list"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/**
 * REMEMBER ME ‚Äî single-file browser game (Pixel 3D + offline fallback)
 * Core goals:
 * - No checklist shown; player deduces actions via environment/UI hints
 * - Night simulation validates security checks; missing -> incident (loss)
 * - Score starts at 100%; penalties; hints also penalize
 * - One day / one office location with 6 zones + "Go Home" door
 *
 * This file works offline. If Three.js CDN fails, it uses a minimal canvas fallback renderer.
 */

(() => {
  "use strict";

  // ---------- Utilities ----------
  const $ = (sel) => document.querySelector(sel);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const now = () => performance.now();

  function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }
  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  // ---------- UI Elements ----------
  const el = {
    overlay: $("#overlay"),
    btnStart: $("#btnStart"),
    btnLockMouse: $("#btnLockMouse"),
    threeCanvas: $("#threeCanvas"),
    fbCanvas: $("#fallbackCanvas"),
    prompt: $("#centerPrompt"),
    promptBig: $("#promptBig"),
    promptSmall: $("#promptSmall"),
    timeBadge: $("#timeBadge"),
    hintBadge: $("#hintBadge"),
    zoneBadge: $("#zoneBadge"),
    lockBadge: $("#lockBadge"),
    renderBadge: $("#renderBadge"),
    pausedTag: $("#pausedTag"),
    logToast: $("#logToast"),

    phone: $("#phone"),
    phoneClose: $("#btnClosePhone"),
    tabs: Array.from(document.querySelectorAll(".tab")),
    tabBodies: {
      help: $("#tab_help"),
      log: $("#tab_log"),
      hint: $("#tab_hint")
    },
    logList: $("#logList"),
    btnUseHint: $("#btnUseHint"),
    hintLeft2: $("#hintLeft2"),
    hintText: $("#hintText"),
    btnPixMinus: $("#btnPixMinus"),
    btnPixPlus: $("#btnPixPlus"),
    pixInfo: $("#pixInfo"),

    report: $("#report"),
    reportTitle: $("#reportTitle"),
    reportSubtitle: $("#reportSubtitle"),
    finalPct: $("#finalPct"),
    finalVerdict: $("#finalVerdict"),
    finalTime: $("#finalTime"),
    finalSummary: $("#finalSummary"),
    finalRecs: $("#finalRecs"),
    finalLog: $("#finalLog"),
    btnRestart: $("#btnRestart")
  };

  // ---------- Game Data / Checks ----------
  const PENALTIES = {
    // Examples given + expanded
    twoFA_off: { pts: 10, msg: "2FA –≤—ã–∫–ª—é—á–µ–Ω–∞ (—Ä–∏—Å–∫ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ —É—á—ë—Ç–∫–∏)" },
    phishing_open: { pts: 5, msg: "–û—Ç–∫—Ä—ã—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ/–≤–ª–æ–∂–µ–Ω–∏–µ (—Ä–∏—Å–∫ –∑–∞—Ä–∞–∂–µ–Ω–∏—è)" },
    workstation_unlocked: { pts: 3, msg: "–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (–ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø)" },

    usb_left: { pts: 6, msg: "USB –æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –ü–ö (–≤—ã–Ω–æ—Å/–∑–∞—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–æ—Å–∏—Ç–µ–ª—å)" },
    updates_off: { pts: 6, msg: "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã (–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏)" },
    av_not_run: { pts: 4, msg: "–ê–Ω—Ç–∏–≤–∏—Ä—É—Å/—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ (–ø—Ä–æ–ø—É—Å–∫ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤)" },

    default_password: { pts: 8, msg: "–û—Å—Ç–∞–≤–ª–µ–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å (–ø–æ–¥–±–æ—Ä/—É—Ç–µ—á–∫–∞ –±–∞–∑)" },
    weak_password: { pts: 6, msg: "–°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å (–ª–µ–≥–∫–æ —É–≥–∞–¥–∞—Ç—å/–ø–æ–¥–æ–±—Ä–∞—Ç—å)" },
    reused_password: { pts: 6, msg: "–ü–∞—Ä–æ–ª—å –Ω–µ —É–Ω–∏–∫–∞–ª–µ–Ω (credential stuffing)" },
    browser_pw_on: { pts: 4, msg: "–ü–∞—Ä–æ–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (—Ä–∏—Å–∫ —ç–∫—Å—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)" },

    unknown_device: { pts: 7, msg: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ —Å–µ—Ç–∏ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∞—Ç–∞–∫–∞)" },
    guest_wifi_on: { pts: 5, msg: "–ì–æ—Å—Ç–µ–≤–æ–π Wi-Fi –≤–∫–ª—é—á—ë–Ω –±–µ–∑ –Ω—É–∂–¥—ã (–ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –∞—Ç–∞–∫–∏)" },
    firmware_old: { pts: 5, msg: "–ü—Ä–æ—à–∏–≤–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞ —É—Å—Ç–∞—Ä–µ–ª–∞ (—ç–∫—Å–ø–ª–æ–π—Ç—ã)" },

    cloud_public: { pts: 8, msg: "–ü—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –≤ –æ–±–ª–∞–∫–µ (—É—Ç–µ—á–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)" },
    cloud_everyone: { pts: 6, msg: "–î–æ—Å—Ç—É–ø '–≤—Å–µ–º –ø–æ —Å—Å—ã–ª–∫–µ' (–Ω–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ)" },
    cloud_alerts_off: { pts: 3, msg: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–µ –≤—ã–∫–ª—é—á–µ–Ω—ã (–ø—Ä–æ–ø—É—Å–∫ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏)" },

    social_public: { pts: 4, msg: "–ü—Ä–æ—Ñ–∏–ª—å —Å–ª–∏—à–∫–æ–º –ø—É–±–ª–∏—á–Ω—ã–π (—Å–æ—Ü.–∏–Ω–∂–µ–Ω–µ—Ä–∏—è)" },
    social_fake_not_blocked: { pts: 5, msg: "–§–µ–π–∫-–∞–∫–∫–∞—É–Ω—Ç –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (—Ñ–∏—à–∏–Ω–≥ —á–µ—Ä–µ–∑ —Å–æ—Ü—Å–µ—Ç–∏)" },
    social_dm_open: { pts: 3, msg: "–õ–° –æ—Ç –≤—Å–µ—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω—ã (–≤–µ–∫—Ç–æ—Ä —Ñ–∏—à–∏–Ω–≥–∞/—Å–ø–∞–º–∞)" },

    hint_used: { pts: 2, msg: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∞ (—à—Ç—Ä–∞—Ñ –∑–∞ –ø–æ–º–æ—â—å)" }
  };

  // Security checks (must be satisfied to win)
  const CRITICAL_CHECKS = [
    "workstationLocked",
    "usbRemoved",
    "updatesOn",
    "twoFAOn",
    "passwordStrongUnique",
    "browserPwOff",
    "phishingSafe",
    "networkSafe",
    "cloudSafe",
    "socialSafe"
  ];

  // ---------- Random scenario generation ----------
  function buildScenario(){
    // Emails: 4 total; 1-2 phishing guaranteed
    const legitPool = [
      { from:"hr@corp.local", subj:"–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —É–¥–∞–ª—ë–Ω–∫–∏", body:"–ö–æ—Ä–æ—Ç–∫–∏–π –∞–Ω–æ–Ω—Å, –±–µ–∑ –≤–ª–æ–∂–µ–Ω–∏–π. –°—Å—ã–ª–∫–∞ –≤–µ–¥—ë—Ç –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç–∞–ª.", kind:"legit", link:"intra://policy" },
      { from:"it@corp.local", subj:"–ü–ª–∞–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ VPN-–∫–ª–∏–µ–Ω—Ç–∞", body:"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –ø–æ—Ä—Ç–∞–ª–∞. –í–ª–æ–∂–µ–Ω–∏—è –Ω–µ—Ç.", kind:"legit", link:"intra://vpn" },
      { from:"finance@corp.local", subj:"–û—Ç—á—ë—Ç –ø–æ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞–º –∑–∞ —è–Ω–≤–∞—Ä—å", body:"–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä. –ë–µ–∑ –ø—Ä–æ—Å—å–± –≤–≤–æ–¥–∏—Ç—å –ø–∞—Ä–æ–ª—å.", kind:"legit", link:"intra://trips" },
      { from:"teamlead@corp.local", subj:"–°–æ–∑–≤–æ–Ω –≤ 16:30", body:"–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ. –ù–∏–∫–∞–∫–∏—Ö —Ñ–∞–π–ª–æ–≤.", kind:"legit", link:"intra://meet" }
    ];
    const phishPool = [
      { from:"security-alert@cor—Ä.local", subj:"–°–†–û–ß–ù–û: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è", body:"–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–∞–µ—Ç. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –≤–æ–π–¥–∏—Ç–µ.", kind:"phish", link:"http://corp-login.verify-session.example" },
      { from:"delivery@ship-fast.example", subj:"–ù–µ—É–¥–∞—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞: –æ—Ç–∫—Ä–æ–π—Ç–µ –∞–∫—Ç", body:"–í–ª–æ–∂–µ–Ω–∏–µ 'act.zip'. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å.", kind:"phish", attach:"act.zip" },
      { from:"payments@fin–∞nce.local", subj:"–°—á—ë—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω ‚Äî –æ–ø–ª–∞—Ç–∏—Ç—å", body:"–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É. –î–∞–≤–ª–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏.", kind:"phish", link:"http://pay-now.invoice-check.example" }
    ];
    const emails = shuffle([...legitPool]).slice(0, 4);
    // Replace 1-2 with phishing
    const phCount = (Math.random() < 0.55) ? 2 : 1;
    const idxs = shuffle([0,1,2,3]).slice(0, phCount);
    const pickedPh = shuffle([...phishPool]).slice(0, phCount);
    idxs.forEach((i, k) => emails[i] = pickedPh[k]);
    // Devices: list + maybe suspicious guaranteed (for gameplay)
    const knownDevices = [
      { name:"Office-PC", mac:"A4:11:2C:9D:1F:02", trust:"known" },
      { name:"Printer-3F", mac:"B0:22:10:AA:77:03", trust:"known" },
      { name:"Meeting-TV", mac:"10:9F:EA:01:02:03", trust:"known" }
    ];
    const suspicious = { name: choice(["Android-??","iPhone-??","ESP32-Board","Unknown-Device"]), mac:"DE:AD:BE:EF:"+String(Math.floor(Math.random()*90+10))+":"+String(Math.floor(Math.random()*90+10)), trust:"unknown" };
    const devices = shuffle([...knownDevices, suspicious]);

    // Cloud folders: at least one public link present
    const folders = shuffle([
      { name:"Roadmap_Q1", share:"team", publicLink:false },
      { name:"Incidents_Notes", share:"team", publicLink:true },       // risky
      { name:"Budget_Drafts", share:"everyone", publicLink:false },    // risky
      { name:"Onboarding", share:"team", publicLink:false }
    ]).slice(0,4);
    // Ensure at least one publicLink true
    if(!folders.some(f=>f.publicLink)) folders[0].publicLink = true;
    // Ensure at least one "everyone" sometimes
    if(!folders.some(f=>f.share==="everyone") && Math.random()<0.8) folders[1].share="everyone";

    // Social: fake account always exists
    const fake = {
      name: choice(["hr-support_official","it_helpdesk_secure","corp.security.team","teamlead_backup"]),
      note:"–ü–æ—Ö–æ–∂–µ–µ –∏–º—è –∏ –∞–≤–∞—Ç–∞—Ä. –ü—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.",
      isFake:true,
      blocked:false
    };

    return {
      emails,
      devices,
      folders,
      fakeAccount: fake
    };
  }

  // ---------- Finite State Machine ----------
  const State = Object.freeze({
    BOOT:"BOOT",
    MENU:"MENU",
    PLAYING:"PLAYING",
    PAUSED:"PAUSED",
    MODAL:"MODAL",
    REPORT:"REPORT"
  });

  // ---------- Core Game ----------
  const game = {
    state: State.BOOT,
    rendererMode: "unknown", // "three" | "fallback"
    // Time pressure
    dayLengthSec: 8 * 60,
    timeLeftSec: 8 * 60,
    startedAt: 0,
    lastTick: 0,

    // Score / hints / logs
    score: 100,
    hintsLeft: 3,
    hintsUsed: 0,
    logs: [],

    // Scenario
    scenario: buildScenario(),

    // Checks / flags
    checks: {
      workstationLocked: false,
      usbRemoved: false,
      updatesOn: false,
      avRun: false,

      passwordChanged: false,
      passwordStrong: false,
      passwordUnique: false,
      twoFAOn: false,
      browserPwOff: false,

      phishingSafe: true, // becomes false if user opens phishing
      phishingReported: 0, // count
      phishingOpened: 0,

      unknownDeviceRemoved: false,
      guestWifiOff: false,
      firmwareUpdated: false,

      cloudNoPublicLinks: false,
      cloudNoEveryone: false,
      cloudAlertsOn: false,

      socialPrivacyTight: false,
      socialFakeBlocked: false,
      socialDmRestricted: false
    },

    // Derived per-zone label (no checklist)
    currentZone: "‚Äî",

    // Player movement
    input: {
      keys: new Set(),
      mouseDX: 0,
      mouseDY: 0,
      pointerLocked: false
    }
  };

  function logEvent(title, detail){
    const ts = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    game.logs.push({ts, title, detail});
    // Toast
    const div = document.createElement("div");
    div.className = "toast";
    div.innerHTML = `<div class="t">${escapeHtml(title)}</div><div class="d">${escapeHtml(detail)}</div>`;
    el.logToast.prepend(div);
    requestAnimationFrame(()=>div.classList.add("show"));
    setTimeout(()=>{ div.classList.remove("show"); setTimeout(()=>div.remove(), 250); }, 2400);
    renderLogList();
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  function setState(next){
    game.state = next;
    el.pausedTag.classList.toggle("show", next === State.PAUSED);
    // Phone blocks pointer lock
    if(next === State.MODAL || next === State.REPORT || next === State.MENU){
      closePointerLock();
    }
  }

  function updateHUD(){
    el.timeBadge.textContent = `‚è≥ ${fmtTime(game.timeLeftSec)}`;
    el.hintBadge.textContent = `üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏: ${game.hintsLeft}`;
    el.hintLeft2.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${game.hintsLeft}`;
    el.lockBadge.textContent = game.input.pointerLocked ? "üîí –ú—ã—à—å: –∑–∞—Ö–≤–∞—á–µ–Ω–∞" : "üîì –ú—ã—à—å: —Å–≤–æ–±–æ–¥–Ω–∞";
    el.zoneBadge.textContent = `–ó–æ–Ω–∞: ${game.currentZone}`;
  }

  // ---------- Hints (no checklist, only directional) ----------
  function computeHint(){
    // Prioritize risky/unfinished clusters with "soft" phrasing.
    const c = game.checks;

    const candidates = [];
    if(!c.workstationLocked || !c.usbRemoved || !c.updatesOn) {
      candidates.push("–ù–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ –º–µ–ª–æ—á–∏ —Ä–µ—à–∞—é—Ç –∏—Å—Ö–æ–¥ –Ω–æ—á–∏: —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø, –Ω–æ—Å–∏—Ç–µ–ª–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.");
    }
    if(!c.twoFAOn || !c.browserPwOff || !(c.passwordStrong && c.passwordUnique)) {
      candidates.push("–£—á—ë—Ç–∫–∏ —á–∞—â–µ –ª–æ–º–∞—é—Ç –Ω–µ —ç–∫—Å–ø–ª–æ–π—Ç–∞–º–∏, –∞ –ø—Ä–∏–≤—ã—á–∫–∞–º–∏: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏, –ø–æ–≤—Ç–æ—Ä –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ 2FA.");
    }
    if(c.phishingSafe && game.scenario.emails.some(e=>e.kind==="phish") && c.phishingReported === 0){
      candidates.push("–ü–æ—á—Ç–∞ –æ–±—ã—á–Ω–æ —à—É–º–Ω–∞—è: –∏—â–∏ –ø–∏—Å—å–º–∞, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞–≤—è—Ç –Ω–∞ —Å—Ä–æ—á–Ω–æ—Å—Ç—å –∏–ª–∏ –ø—Ä–æ—Å—è—Ç –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ –¥–æ–º–µ–Ω—ã/–≤–ª–æ–∂–µ–Ω–∏—è.");
    }
    if(!c.unknownDeviceRemoved || !c.guestWifiOff || !c.firmwareUpdated){
      candidates.push("–°–µ—Ç—å ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–∞—Ä–æ–ª—å –æ—Ç Wi-Fi. –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –≥–æ—Å—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∏ –ø—Ä–æ—à–∏–≤–∫–∞ ‚Äî —á–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–æ—á–Ω—ã—Ö —Å—é—Ä–ø—Ä–∏–∑–æ–≤.");
    }
    if(!c.cloudNoPublicLinks || !c.cloudNoEveryone || !c.cloudAlertsOn){
      candidates.push("–û–±–ª–∞–∫–æ —á–∞—Å—Ç–æ ¬´—Ç–µ—á—ë—Ç¬ª —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫–∏ –∏ –ø—Ä–∞–≤–∞. –ü—Ä–æ–≤–µ—Ä—å –ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–∞—Ö.");
    }
    if(!c.socialFakeBlocked || !c.socialPrivacyTight || !c.socialDmRestricted){
      candidates.push("–°–æ—Ü—Å–µ—Ç–∏ ‚Äî –ª—é–±–∏–º—ã–π –∫–∞–Ω–∞–ª —Å–æ—Ü–∏–Ω–∂–µ–Ω–µ—Ä–∏–∏: —Ñ–µ–π–∫–∏, –æ—Ç–∫—Ä—ã—Ç–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –∏ –õ–° ¬´–¥–ª—è –≤—Å–µ—Ö¬ª.");
    }
    if(candidates.length === 0) candidates.push("–ü–æ—Ö–æ–∂–µ, –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∏—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã. –û—Å—Ç–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å, –≥–æ—Ç–æ–≤ –ª–∏ –æ—Ñ–∏—Å –∫ –Ω–æ—á–∏.");

    return choice(candidates);
  }

  function useHint(){
    if(game.hintsLeft <= 0) return;
    game.hintsLeft--;
    game.hintsUsed++;
    game.score = Math.max(0, game.score - PENALTIES.hint_used.pts);
    el.hintText.textContent = computeHint();
    logEvent("–ü–æ–¥—Å–∫–∞–∑–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞", "–ù–∞–º—ë–∫ –≤—ã–¥–∞–Ω. –ò—Ç–æ–≥–æ–≤—ã–π % —Å–Ω–∏–∂–µ–Ω.");
    updateHUD();
  }

  // ---------- Phone UI ----------
  function openPhone(){
    if(game.state === State.REPORT) return;
    el.phone.classList.add("show");
    setState(State.MODAL);
    renderLogList();
    el.hintText.textContent = "‚Äî";
    el.pixInfo.textContent = `scale: ${render.pixelScale.toFixed(2)}`;
  }
  function closePhone(){
    el.phone.classList.remove("show");
    if(game.state === State.MODAL) setState(State.PLAYING);
  }
  function setTab(name){
    el.tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    for(const k of Object.keys(el.tabBodies)){
      el.tabBodies[k].style.display = (k === name) ? "" : "none";
    }
  }
  el.tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));
  el.phoneClose.addEventListener("click", closePhone);
  el.btnUseHint.addEventListener("click", useHint);
  el.btnPixMinus.addEventListener("click", () => { render.setPixelScale(render.pixelScale * 0.90); el.pixInfo.textContent = `scale: ${render.pixelScale.toFixed(2)}`; });
  el.btnPixPlus.addEventListener("click", () => { render.setPixelScale(render.pixelScale * 1.10); el.pixInfo.textContent = `scale: ${render.pixelScale.toFixed(2)}`; });

  function renderLogList(){
    const list = el.logList;
    list.innerHTML = "";
    const last = game.logs.slice(-60).reverse();
    if(last.length === 0){
      list.innerHTML = `<div class="item"><div class="meta">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–µ–π—Å—Ç–≤–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</div></div>`;
      return;
    }
    for(const e of last){
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `<div class="top"><div><div class="name">${escapeHtml(e.title)}</div><div class="meta">${escapeHtml(e.detail)}</div></div><div class="meta mono">${escapeHtml(e.ts)}</div></div>`;
      list.appendChild(it);
    }
  }

  // ---------- Interaction Modal (per object) ----------
  let activeTask = null;

  function openTaskUI(taskId){
    activeTask = taskId;
    el.phone.classList.add("show");
    setState(State.MODAL);
    setTab("help"); // will switch to content pane below
    // Replace phone content with task UI on top of tabs (still keep close)
    injectTask(taskId);
  }

  function injectTask(taskId){
    // Build task UI inside phoneCard (below header)
    // Keep tabs; add a new temporary body "task"
    const existing = $("#tab_task");
    if(existing) existing.remove();

    const task = document.createElement("div");
    task.id = "tab_task";
    task.className = "tabBody";
    task.style.display = "";
    // Hide other bodies
    for(const k of Object.keys(el.tabBodies)) el.tabBodies[k].style.display = "none";
    // Deactivate tabs
    el.tabs.forEach(t => t.classList.remove("active"));

    const content = taskContent(taskId);
    task.innerHTML = content.html;
    el.phoneCard.appendChild(task);

    // Wire actions
    content.bind(task);

    // Add top hint
    const hdrHint = document.createElement("div");
    hdrHint.className = "hint";
    hdrHint.style.margin = "8px 0 12px 0";
    hdrHint.textContent = "–ó–∞–∫—Ä–æ–π: Tab. –≠—Ç–æ –Ω–µ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ç–µ–∫—É—â–µ–π –∑–æ–Ω—ã.";
    task.prepend(hdrHint);
  }

  function closeTaskUI(){
    const t = $("#tab_task");
    if(t) t.remove();
    activeTask = null;
    // return to phone home tabs
    setTab("help");
  }

  function taskContent(taskId){
    const c = game.checks;
    const scenario = game.scenario;

    if(taskId === "workstation"){
      return {
        html: `
          <div class="section">
            <h2>–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ ‚Äî –ü–ö</h2>
            <p>–û–±—ã—á–Ω–∞—è —Ä—É—Ç–∏–Ω–∞. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–µ—â–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã –Ω–æ—á—å—é.</p>

            <div class="toggle">
              <input id="ws_lock" type="checkbox" ${c.workstationLocked?"checked":""}/>
              <div>
                <div class="name">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏—é –ø–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º</div>
                <div class="meta">–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º ‚Äî –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø –Ω–æ—á—å—é.</div>
              </div>
            </div>

            <div class="toggle">
              <input id="ws_usb" type="checkbox" ${c.usbRemoved?"checked":""}/>
              <div>
                <div class="name">–ò–∑–≤–ª–µ—á—å USB-—Ñ–ª–µ—à–∫—É</div>
                <div class="meta">–ù–æ—Å–∏—Ç–µ–ª—å ‚Äî —á–∞—Å—Ç—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞—Ä–∞–∂–µ–Ω–∏—è/–≤—ã–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö.</div>
              </div>
            </div>

            <div class="toggle">
              <input id="ws_updates" type="checkbox" ${c.updatesOn?"checked":""}/>
              <div>
                <div class="name">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</div>
                <div class="meta">–í—ã–∫–ª—é—á–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–≤—ã—à–∞—é—Ç —Ä–∏—Å–∫ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π.</div>
              </div>
            </div>

            <div class="rowLine">
              <button class="btn small good" id="ws_scan">–ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ã—Å—Ç—Ä—É—é –ø—Ä–æ–≤–µ—Ä–∫—É</button>
              <span class="badge ${c.avRun?"good":"warn"}" id="ws_scan_badge">${c.avRun?"–ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—ã–ø–æ–ª–Ω–µ–Ω–∞":"–ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å"}</span>
            </div>

            <div class="hr"></div>
            <div class="hint">–°—Ç–∏–∫–µ—Ä –Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä–µ: ¬´–ü–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º: Win+L, –Ω–æ—Å–∏—Ç–µ–ª–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è¬ª.</div>
          </div>
        `,
        bind(root){
          root.querySelector("#ws_lock").addEventListener("change", (e)=>{
            c.workstationLocked = e.target.checked;
            logEvent("–ü–ö", c.workstationLocked ? "–°–µ—Å—Å–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞." : "–°–µ—Å—Å–∏—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π.");
          });
          root.querySelector("#ws_usb").addEventListener("change", (e)=>{
            c.usbRemoved = e.target.checked;
            logEvent("USB", c.usbRemoved ? "USB –∏–∑–≤–ª–µ—á—ë–Ω." : "USB –æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –ü–ö.");
          });
          root.querySelector("#ws_updates").addEventListener("change", (e)=>{
            c.updatesOn = e.target.checked;
            logEvent("–û–±–Ω–æ–≤–ª–µ–Ω–∏—è", c.updatesOn ? "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã." : "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã.");
          });
          root.querySelector("#ws_scan").addEventListener("click", ()=>{
            c.avRun = true;
            root.querySelector("#ws_scan_badge").textContent = "–ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—ã–ø–æ–ª–Ω–µ–Ω–∞";
            root.querySelector("#ws_scan_badge").className = "badge good";
            logEvent("–ü—Ä–æ–≤–µ—Ä–∫–∞", "–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω—ã).");
          });
        }
      };
    }

    if(taskId === "accounts"){
      const defaultPwd = !c.passwordChanged;
      const pwdStrong = c.passwordStrong;
      const pwdUnique = c.passwordUnique;

      return {
        html: `
          <div class="section">
            <h2>–£—á—ë—Ç–∫–∏ –∏ –ø–∞—Ä–æ–ª–∏ ‚Äî —Ç–µ—Ä–º–∏–Ω–∞–ª</h2>
            <p>–ö–æ–ª–ª–µ–≥–∞ –≤ —á–∞—Ç–µ: ¬´–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å—Ç–∞–∂—ë—Ä—Å–∫–∏–π –ø–∞—Ä–æ–ª—å –Ω–µ –æ—Å—Ç–∞–ª—Å—è 'Welcome123'¬ª.</p>

            <div class="field">
              <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è, —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª)</label>
              <input id="acc_pwd" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å..." />
              <div class="hint">–ü—Ä–∞–≤–∏–ª–∞: –¥–ª–∏–Ω–∞ ‚â• 12, –±—É–∫–≤—ã —Ä–∞–∑–Ω–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞, —Ü–∏—Ñ—Ä—ã, —Å–∏–º–≤–æ–ª. –ù–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Ö–æ–∂ –Ω–∞ 'Welcome123'.</div>
            </div>

            <div class="toggle">
              <input id="acc_unique" type="checkbox" ${pwdUnique?"checked":""}/>
              <div>
                <div class="name">–ü–∞—Ä–æ–ª—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π (–Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏)</div>
                <div class="meta">–ü–æ–≤—Ç–æ—Ä –ø–∞—Ä–æ–ª–µ–π ‚Üí credential stuffing.</div>
              </div>
            </div>

            <div class="toggle">
              <input id="acc_2fa" type="checkbox" ${c.twoFAOn?"checked":""}/>
              <div>
                <div class="name">–í–∫–ª—é—á–∏—Ç—å 2FA</div>
                <div class="meta">–ë–µ–∑ 2FA –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è —É—á—ë—Ç–∫–∏ –æ–±—ã—á–Ω–æ –≤–æ–ø—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏.</div>
              </div>
            </div>

            <div class="toggle">
              <input id="acc_browser" type="checkbox" ${!c.browserPwOff?"checked":""}/>
              <div>
                <div class="name">–†–∞–∑—Ä–µ—à–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
                <div class="meta">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç–∫–ª—é—á–∏—Ç—å –Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏—è—Ö.</div>
              </div>
            </div>

            <div class="rowLine">
              <span class="badge ${defaultPwd?"bad":"good"}" id="acc_default">${defaultPwd?"–°—Ç–∞—Ç—É—Å: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å":"–°—Ç–∞—Ç—É—Å: –ø–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω"}</span>
              <span class="badge ${pwdStrong?"good":"warn"}" id="acc_strength">${pwdStrong?"–°–∏–ª–∞: –æ–∫":"–°–∏–ª–∞: —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ"}</span>
              <span class="badge ${pwdUnique?"good":"warn"}" id="acc_unique_badge">${pwdUnique?"–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –æ–∫":"–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞"}</span>
            </div>

            <div class="hr"></div>
            <button class="btn small primary" id="acc_apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          </div>
        `,
        bind(root){
          const inp = root.querySelector("#acc_pwd");
          const tUnique = root.querySelector("#acc_unique");
          const t2fa = root.querySelector("#acc_2fa");
          const tBrowser = root.querySelector("#acc_browser");

          function checkStrength(p){
            if(!p) return false;
            if(p.toLowerCase().includes("welcome")) return false;
            if(p.length < 12) return false;
            const hasU = /[A-Z]/.test(p);
            const hasL = /[a-z]/.test(p);
            const hasD = /\d/.test(p);
            const hasS = /[^A-Za-z0-9]/.test(p);
            return hasU && hasL && hasD && hasS;
          }

          root.querySelector("#acc_apply").addEventListener("click", ()=>{
            const p = inp.value || "";
            c.passwordChanged = p.length > 0;
            c.passwordStrong = checkStrength(p);
            c.passwordUnique = !!tUnique.checked;
            c.twoFAOn = !!t2fa.checked;
            c.browserPwOff = !tBrowser.checked;

            root.querySelector("#acc_default").textContent = c.passwordChanged ? "–°—Ç–∞—Ç—É—Å: –ø–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω" : "–°—Ç–∞—Ç—É—Å: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å";
            root.querySelector("#acc_default").className = "badge " + (c.passwordChanged ? "good":"bad");

            root.querySelector("#acc_strength").textContent = c.passwordStrong ? "–°–∏–ª–∞: –æ–∫" : "–°–∏–ª–∞: —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ";
            root.querySelector("#acc_strength").className = "badge " + (c.passwordStrong ? "good":"warn");

            root.querySelector("#acc_unique_badge").textContent = c.passwordUnique ? "–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –æ–∫" : "–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞";
            root.querySelector("#acc_unique_badge").className = "badge " + (c.passwordUnique ? "good":"warn");

            logEvent("–£—á—ë—Ç–∫–∏", "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—á—ë—Ç–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã.");
            if(c.twoFAOn) logEvent("2FA", "2FA –≤–∫–ª—é—á–µ–Ω–∞.");
            if(c.browserPwOff) logEvent("–ë—Ä–∞—É–∑–µ—Ä", "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –æ—Ç–∫–ª—é—á–µ–Ω–æ.");
          });

          tBrowser.addEventListener("change", ()=>{
            // no log spam; will be logged on apply
          });
        }
      };
    }

    if(taskId === "mail"){
      // Build email list HTML
      const emailsHtml = scenario.emails.map((m, i) => {
        const kindTag = (m.kind==="phish") ? `<span class="badge bad">–ø–æ–¥–æ–∑—Ä.</span>` : `<span class="badge good">–≤–Ω—É—Ç—Ä.</span>`;
        const attach = m.attach ? ` ¬∑ <span class="badge warn">–≤–ª–æ–∂–µ–Ω–∏–µ: ${escapeHtml(m.attach)}</span>` : "";
        const link = m.link ? ` ¬∑ <span class="badge">${escapeHtml(m.link.startsWith("intra://")?"–≤–Ω—É—Ç—Ä. —Å—Å—ã–ª–∫–∞":"–≤–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞")}</span>` : "";
        return `
          <div class="item" data-mail="${i}">
            <div class="top">
              <div>
                <div class="name">${escapeHtml(m.subj)} ${kindTag}</div>
                <div class="meta">–û—Ç: <span class="mono">${escapeHtml(m.from)}</span>${attach}${link}</div>
              </div>
              <div class="meta mono">#${i+1}</div>
            </div>
            <div class="meta" style="margin-top:6px">${escapeHtml(m.body)}</div>
            <div class="actions">
              <button class="btn small" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
              <button class="btn small" data-act="report">–°–æ–æ–±—â–∏—Ç—å –∫–∞–∫ —Ñ–∏—à–∏–Ω–≥</button>
              <button class="btn small" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        `;
      }).join("");

      return {
        html: `
          <div class="section">
            <h2>–ü–æ—á—Ç–∞ ‚Äî —Ç–µ—Ä–º–∏–Ω–∞–ª</h2>
            <p>–°—Ç–∏–∫–µ—Ä –Ω–∞ —Ä–∞–º–∫–µ: ¬´–ù–µ —Å–ø–µ—à–∏. –°–º–æ—Ç—Ä–∏ –Ω–∞ –¥–æ–º–µ–Ω, —Å—Ä–æ—á–Ω–æ—Å—Ç—å, –≤–ª–æ–∂–µ–Ω–∏—è –∏ –≤–Ω–µ—à–Ω–∏–π URL¬ª.</p>
            <div class="list">${emailsHtml}</div>
            <div class="hr"></div>
            <div class="rowLine">
              <span class="badge ${game.checks.phishingOpened>0?"bad":"good"}" id="mail_opened">–û—Ç–∫—Ä—ã—Ç–æ –ø–æ–¥–æ–∑—Ä.: ${game.checks.phishingOpened}</span>
              <span class="badge" id="mail_reported">–°–æ–æ–±—â–µ–Ω–æ: ${game.checks.phishingReported}</span>
              <span class="hint">–û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∏—Å—å–º–∞ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –Ω–æ—á—å—é.</span>
            </div>
          </div>
        `,
        bind(root){
          root.querySelectorAll("[data-mail]").forEach(card=>{
            const idx = Number(card.getAttribute("data-mail"));
            const msg = scenario.emails[idx];
            card.querySelectorAll("button[data-act]").forEach(btn=>{
              btn.addEventListener("click", ()=>{
                const act = btn.getAttribute("data-act");
                if(act === "open"){
                  logEvent("–ü–æ—á—Ç–∞", `–û—Ç–∫—Ä—ã—Ç–æ –ø–∏—Å—å–º–æ: "${msg.subj}".`);
                  if(msg.kind === "phish"){
                    game.checks.phishingSafe = false;
                    game.checks.phishingOpened++;
                    logEvent("–†–∏—Å–∫", "–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ. –ù–æ—á—å—é —ç—Ç–æ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –∑–∞—Ä–∞–∂–µ–Ω–∏–µ–º.");
                    root.querySelector("#mail_opened").textContent = `–û—Ç–∫—Ä—ã—Ç–æ –ø–æ–¥–æ–∑—Ä.: ${game.checks.phishingOpened}`;
                    root.querySelector("#mail_opened").className = "badge bad";
                  }
                } else if(act === "report"){
                  if(msg.kind === "phish"){
                    game.checks.phishingReported++;
                    logEvent("–ü–æ—á—Ç–∞", `–°–æ–æ–±—â–µ–Ω–æ –ò–ë: "${msg.subj}".`);
                  } else {
                    logEvent("–ü–æ—á—Ç–∞", `–ü–æ–º–µ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: "${msg.subj}" (–≤–æ–∑–º–æ–∂–Ω–æ –ª–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ).`);
                  }
                  root.querySelector("#mail_reported").textContent = `–°–æ–æ–±—â–µ–Ω–æ: ${game.checks.phishingReported}`;
                } else if(act === "delete"){
                  logEvent("–ü–æ—á—Ç–∞", `–£–¥–∞–ª–µ–Ω–æ –ø–∏—Å—å–º–æ: "${msg.subj}".`);
                  card.style.opacity = .55;
                  card.querySelectorAll("button").forEach(b=>b.disabled=true);
                }
              });
            });
          });
        }
      };
    }

    if(taskId === "network"){
      const devHtml = scenario.devices.map((d,i)=>{
        const badge = d.trust==="unknown" ? `<span class="badge bad">–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>` : `<span class="badge good">–∏–∑–≤–µ—Å—Ç–Ω–æ</span>`;
        return `
          <div class="item" data-dev="${i}">
            <div class="top">
              <div>
                <div class="name">${escapeHtml(d.name)} ${badge}</div>
                <div class="meta mono">${escapeHtml(d.mac)}</div>
              </div>
              <div class="meta">${d.trust==="unknown"?"‚ö†":"‚úì"}</div>
            </div>
            <div class="actions">
              <button class="btn small" data-act="kick">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
              <button class="btn small" data-act="whitelist">–ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ</button>
            </div>
          </div>
        `;
      }).join("");

      return {
        html: `
          <div class="section">
            <h2>–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç—å ‚Äî —Ä–æ—É—Ç–µ—Ä/—â–∏—Ç–æ–∫</h2>
            <p>–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–∏–≥–∞–µ—Ç: ¬´–ù–æ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å: 1¬ª.</p>

            <div class="toggle">
              <input id="net_guest" type="checkbox" ${!c.guestWifiOff?"checked":""}/>
              <div>
                <div class="name">–ì–æ—Å—Ç–µ–≤–æ–π Wi-Fi –≤–∫–ª—é—á—ë–Ω</div>
                <div class="meta">–ï—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω ‚Äî –ª—É—á—à–µ –≤—ã–∫–ª—é—á–∏—Ç—å.</div>
              </div>
            </div>

            <div class="toggle">
              <input id="net_alert" type="checkbox" checked disabled />
              <div>
                <div class="name">–õ–æ–≥–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –≤–∫–ª—é—á–µ–Ω—ã</div>
                <div class="meta">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä.</div>
              </div>
            </div>

            <div class="rowLine">
              <button class="btn small good" id="net_fw">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—à–∏–≤–∫—É</button>
              <span class="badge ${c.firmwareUpdated?"good":"warn"}" id="net_fw_badge">${c.firmwareUpdated?"–ü—Ä–æ—à–∏–≤–∫–∞: –∞–∫—Ç—É–∞–ª—å–Ω–∞":"–ü—Ä–æ—à–∏–≤–∫–∞: —É—Å—Ç–∞—Ä–µ–ª–∞"}</span>
            </div>

            <div class="hr"></div>
            <div class="name">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
            <div class="list">${devHtml}</div>

            <div class="hr"></div>
            <span class="badge ${c.unknownDeviceRemoved?"good":"warn"}" id="net_unknown">${c.unknownDeviceRemoved?"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã":"–ï—Å—Ç—å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"}</span>
          </div>
        `,
        bind(root){
          const tGuest = root.querySelector("#net_guest");
          tGuest.addEventListener("change", ()=>{
            c.guestWifiOff = !tGuest.checked;
            logEvent("–°–µ—Ç—å", c.guestWifiOff ? "–ì–æ—Å—Ç–µ–≤–æ–π Wi-Fi –≤—ã–∫–ª—é—á–µ–Ω." : "–ì–æ—Å—Ç–µ–≤–æ–π Wi-Fi –≤–∫–ª—é—á—ë–Ω.");
          });

          root.querySelector("#net_fw").addEventListener("click", ()=>{
            c.firmwareUpdated = true;
            const b = root.querySelector("#net_fw_badge");
            b.textContent = "–ü—Ä–æ—à–∏–≤–∫–∞: –∞–∫—Ç—É–∞–ª—å–Ω–∞";
            b.className = "badge good";
            logEvent("–°–µ—Ç—å", "–ü—Ä–æ—à–∏–≤–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.");
          });

          root.querySelectorAll("[data-dev]").forEach(card=>{
            const idx = Number(card.getAttribute("data-dev"));
            const dev = scenario.devices[idx];
            card.querySelectorAll("button[data-act]").forEach(btn=>{
              btn.addEventListener("click", ()=>{
                const act = btn.getAttribute("data-act");
                if(act === "kick"){
                  if(dev.trust === "unknown"){
                    c.unknownDeviceRemoved = true;
                    root.querySelector("#net_unknown").textContent = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã";
                    root.querySelector("#net_unknown").className = "badge good";
                    logEvent("–°–µ—Ç—å", `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ (${dev.name}).`);
                  } else {
                    logEvent("–°–µ—Ç—å", `–û—Ç–∫–ª—é—á–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (${dev.name}).`);
                  }
                  card.style.opacity = .55;
                  card.querySelectorAll("button").forEach(b=>b.disabled=true);
                } else if(act === "whitelist"){
                  if(dev.trust === "unknown"){
                    logEvent("–°–µ—Ç—å", `–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–º–µ—á–µ–Ω–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º (${dev.name}).`);
                    // Still risky: does not satisfy unknownDeviceRemoved
                  } else {
                    logEvent("–°–µ—Ç—å", `–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–∂–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ (${dev.name}).`);
                  }
                }
              });
            });
          });
        }
      };
    }

    if(taskId === "cloud"){
      const folderHtml = scenario.folders.map((f,i)=>{
        const pub = f.publicLink ? `<span class="badge bad">–ø—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞</span>` : `<span class="badge good">–±–µ–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫</span>`;
        const share = f.share==="everyone" ? `<span class="badge warn">–¥–æ—Å—Ç—É–ø: –≤—Å–µ–º –ø–æ —Å—Å—ã–ª–∫–µ</span>` : `<span class="badge good">–¥–æ—Å—Ç—É–ø: –∫–æ–º–∞–Ω–¥–∞</span>`;
        return `
          <div class="item" data-fold="${i}">
            <div class="top">
              <div>
                <div class="name">${escapeHtml(f.name)}</div>
                <div class="meta">${pub} ${share}</div>
              </div>
              <div class="meta">‚òÅ</div>
            </div>
            <div class="actions">
              <button class="btn small" data-act="revoke">–û—Ç–æ–∑–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É</button>
              <button class="btn small" data-act="restrict">–°–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥–µ</button>
            </div>
          </div>
        `;
      }).join("");

      return {
        html: `
          <div class="section">
            <h2>–û–±–ª–∞–∫–æ ‚Äî —Ç–µ—Ä–º–∏–Ω–∞–ª</h2>
            <p>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: ¬´–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ–±—â–∏–µ —Å—Å—ã–ª–∫–∏. –ü—Ä–æ–≤–µ—Ä—å –ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º.¬ª</p>

            <div class="toggle">
              <input id="cloud_alerts" type="checkbox" ${c.cloudAlertsOn?"checked":""}/>
              <div>
                <div class="name">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–∞—Ö –∏ –Ω–æ–≤—ã—Ö —Å–µ—Å—Å–∏—è—Ö</div>
                <div class="meta">–ü–æ–º–æ–≥–∞—é—Ç –±—ã—Å—Ç—Ä–æ –∑–∞–º–µ—Ç–∏—Ç—å –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—é.</div>
              </div>
            </div>

            <div class="hr"></div>
            <div class="name">–ü–∞–ø–∫–∏</div>
            <div class="list">${folderHtml}</div>

            <div class="hr"></div>
            <div class="rowLine">
              <span class="badge ${c.cloudNoPublicLinks?"good":"warn"}" id="cloud_pub">${c.cloudNoPublicLinks?"–ü—É–±–ª–∏—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–µ—Ç":"–ï—Å—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏"}</span>
              <span class="badge ${c.cloudNoEveryone?"good":"warn"}" id="cloud_every">${c.cloudNoEveryone?"–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ '–≤—Å–µ–º'":"–ï—Å—Ç—å –¥–æ—Å—Ç—É–ø '–≤—Å–µ–º'"} </span>
            </div>
          </div>
        `,
        bind(root){
          root.querySelector("#cloud_alerts").addEventListener("change", (e)=>{
            c.cloudAlertsOn = e.target.checked;
            logEvent("–û–±–ª–∞–∫–æ", c.cloudAlertsOn ? "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–∞—Ö –≤–∫–ª—é—á–µ–Ω—ã." : "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–∞—Ö –≤—ã–∫–ª—é—á–µ–Ω—ã.");
          });

          function recompute(){
            c.cloudNoPublicLinks = !scenario.folders.some(f=>f.publicLink);
            c.cloudNoEveryone = !scenario.folders.some(f=>f.share==="everyone");
            root.querySelector("#cloud_pub").textContent = c.cloudNoPublicLinks ? "–ü—É–±–ª–∏—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–µ—Ç" : "–ï—Å—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏";
            root.querySelector("#cloud_pub").className = "badge " + (c.cloudNoPublicLinks ? "good":"warn");
            root.querySelector("#cloud_every").textContent = c.cloudNoEveryone ? "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ '–≤—Å–µ–º'" : "–ï—Å—Ç—å –¥–æ—Å—Ç—É–ø '–≤—Å–µ–º'";
            root.querySelector("#cloud_every").className = "badge " + (c.cloudNoEveryone ? "good":"warn");
          }
          recompute();

          root.querySelectorAll("[data-fold]").forEach(card=>{
            const idx = Number(card.getAttribute("data-fold"));
            const fold = scenario.folders[idx];
            card.querySelectorAll("button[data-act]").forEach(btn=>{
              btn.addEventListener("click", ()=>{
                const act = btn.getAttribute("data-act");
                if(act === "revoke"){
                  if(fold.publicLink){
                    fold.publicLink = false;
                    logEvent("–û–±–ª–∞–∫–æ", `–ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç–æ–∑–≤–∞–Ω–∞: ${fold.name}.`);
                  } else {
                    logEvent("–û–±–ª–∞–∫–æ", `–ü—É–±–ª–∏—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–µ –±—ã–ª–æ: ${fold.name}.`);
                  }
                }
                if(act === "restrict"){
                  if(fold.share === "everyone"){
                    fold.share = "team";
                    logEvent("–û–±–ª–∞–∫–æ", `–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –∫–æ–º–∞–Ω–¥–æ–π: ${fold.name}.`);
                  } else {
                    logEvent("–û–±–ª–∞–∫–æ", `–î–æ—Å—Ç—É–ø —É–∂–µ –∫–æ–º–∞–Ω–¥–Ω—ã–π: ${fold.name}.`);
                  }
                }
                card.querySelector(".meta").innerHTML =
                  `${fold.publicLink ? `<span class="badge bad">–ø—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞</span>` : `<span class="badge good">–±–µ–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫</span>`}
                   ${fold.share==="everyone" ? `<span class="badge warn">–¥–æ—Å—Ç—É–ø: –≤—Å–µ–º –ø–æ —Å—Å—ã–ª–∫–µ</span>` : `<span class="badge good">–¥–æ—Å—Ç—É–ø: –∫–æ–º–∞–Ω–¥–∞</span>`}`;
                recompute();
              });
            });
          });
        }
      };
    }

    if(taskId === "social"){
      const fake = scenario.fakeAccount;

      return {
        html: `
          <div class="section">
            <h2>–°–æ—Ü—Å–µ—Ç–∏ ‚Äî —Ç–µ—Ä–º–∏–Ω–∞–ª</h2>
            <p>–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–ª–ª–µ–≥–∏: ¬´–ú–Ω–µ –ø—Ä–∏—à—ë–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç '—Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏'. –ü—Ä–æ–≤–µ—Ä—å, –Ω–µ —Ñ–µ–π–∫ –ª–∏ —ç—Ç–æ.¬ª</p>

            <div class="toggle">
              <input id="soc_public" type="checkbox" ${!c.socialPrivacyTight?"checked":""}/>
              <div>
                <div class="name">–ü—Ä–æ—Ñ–∏–ª—å –ø—É–±–ª–∏—á–Ω—ã–π</div>
                <div class="meta">–ß–µ–º –±–æ–ª—å—à–µ –æ—Ç–∫—Ä—ã—Ç–æ ‚Äî —Ç–µ–º –ø—Ä–æ—â–µ —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ü.–∏–Ω–∂–µ–Ω–µ—Ä–∏–∏.</div>
              </div>
            </div>

            <div class="toggle">
              <input id="soc_dm" type="checkbox" ${!c.socialDmRestricted?"checked":""}/>
              <div>
                <div class="name">–õ–° —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤—Å–µ–º</div>
                <div class="meta">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–Ω–∏–∂–∞–µ—Ç –ø–æ—Ç–æ–∫ —Ñ–∏—à–∏–Ω–≥–∞ –∏ —Å–ø–∞–º–∞.</div>
              </div>
            </div>

            <div class="hr"></div>
            <div class="item">
              <div class="top">
                <div>
                  <div class="name">${escapeHtml(fake.name)} <span class="badge bad">–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç</span></div>
                  <div class="meta">${escapeHtml(fake.note)}</div>
                </div>
                <div class="meta">üë§</div>
              </div>
              <div class="actions">
                <button class="btn small bad" id="soc_block">${fake.blocked ? "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" : "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å"}</button>
                <button class="btn small" id="soc_report">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button>
              </div>
            </div>

            <div class="hr"></div>
            <div class="rowLine">
              <span class="badge ${c.socialPrivacyTight?"good":"warn"}" id="soc_priv">${c.socialPrivacyTight?"–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å —É—Å–∏–ª–µ–Ω–∞":"–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å —Å–ª–∞–±–∞—è"}</span>
              <span class="badge ${c.socialDmRestricted?"good":"warn"}" id="soc_dm_badge">${c.socialDmRestricted?"–õ–° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã":"–õ–° –æ—Ç–∫—Ä—ã—Ç—ã –≤—Å–µ–º"}</span>
              <span class="badge ${c.socialFakeBlocked?"good":"warn"}" id="soc_fake">${c.socialFakeBlocked?"–§–µ–π–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω":"–§–µ–π–∫ –∞–∫—Ç–∏–≤–µ–Ω"}</span>
            </div>
          </div>
        `,
        bind(root){
          const tPublic = root.querySelector("#soc_public");
          const tDm = root.querySelector("#soc_dm");
          const bPriv = root.querySelector("#soc_priv");
          const bDm = root.querySelector("#soc_dm_badge");
          const bFake = root.querySelector("#soc_fake");
          const btnBlock = root.querySelector("#soc_block");

          tPublic.addEventListener("change", ()=>{
            c.socialPrivacyTight = !tPublic.checked;
            bPriv.textContent = c.socialPrivacyTight ? "–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å —É—Å–∏–ª–µ–Ω–∞" : "–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å —Å–ª–∞–±–∞—è";
            bPriv.className = "badge " + (c.socialPrivacyTight ? "good":"warn");
            logEvent("–°–æ—Ü—Å–µ—Ç–∏", c.socialPrivacyTight ? "–ü—Ä–æ—Ñ–∏–ª—å —Å–¥–µ–ª–∞–Ω –º–µ–Ω–µ–µ –ø—É–±–ª–∏—á–Ω—ã–º." : "–ü—Ä–æ—Ñ–∏–ª—å –æ—Å—Ç–∞–≤–ª–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–º.");
          });

          tDm.addEventListener("change", ()=>{
            c.socialDmRestricted = !tDm.checked;
            bDm.textContent = c.socialDmRestricted ? "–õ–° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã" : "–õ–° –æ—Ç–∫—Ä—ã—Ç—ã –≤—Å–µ–º";
            bDm.className = "badge " + (c.socialDmRestricted ? "good":"warn");
            logEvent("–°–æ—Ü—Å–µ—Ç–∏", c.socialDmRestricted ? "–õ–° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã." : "–õ–° —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤—Å–µ–º.");
          });

          btnBlock.addEventListener("click", ()=>{
            scenario.fakeAccount.blocked = true;
            c.socialFakeBlocked = true;
            btnBlock.textContent = "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω";
            btnBlock.disabled = true;
            bFake.textContent = "–§–µ–π–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω";
            bFake.className = "badge good";
            logEvent("–°–æ—Ü—Å–µ—Ç–∏", "–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.");
          });

          root.querySelector("#soc_report").addEventListener("click", ()=>{
            logEvent("–°–æ—Ü—Å–µ—Ç–∏", "–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç.");
          });
        }
      };
    }

    if(taskId === "home"){
      return {
        html: `
          <div class="section">
            <h2>–õ–∏—Ñ—Ç ‚Äî —É–π—Ç–∏ –¥–æ–º–æ–π</h2>
            <p>–ù–æ—á—å —Å–º–æ–¥–µ–ª–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥–Ω–µ–≤–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π. –ï—Å–ª–∏ –µ—Å—Ç—å –¥—ã—Ä—ã ‚Äî –æ–Ω–∏ ¬´–≤—Å–ø–ª—ã–≤—É—Ç¬ª.</p>
            <div class="rowLine">
              <button class="btn good" id="go_home">–£–π—Ç–∏ –¥–æ–º–æ–π ‚Üí –Ω–æ—á–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è</button>
              <button class="btn" id="go_back">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –æ—Ñ–∏—Å</button>
            </div>
            <div class="hr"></div>
            <div class="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞ —É –ª–∏—Ñ—Ç–∞: ¬´–ü–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º ‚Äî —Ñ–∏–∑–∏–∫–∞, —É—á—ë—Ç–∫–∏, –ø–æ—á—Ç–∞, —Å–µ—Ç—å, –æ–±–ª–∞–∫–æ, —Å–æ—Ü—Å–µ—Ç–∏¬ª.</div>
          </div>
        `,
        bind(root){
          root.querySelector("#go_back").addEventListener("click", ()=>{
            closeTaskUI();
            closePhone();
          });
          root.querySelector("#go_home").addEventListener("click", ()=>{
            closeTaskUI();
            closePhone();
            nightSimulation();
          });
        }
      };
    }

    return { html:`<div class="section"><h2>‚Äî</h2><p>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª.</p></div>`, bind(){} };
  }

  // ---------- Night Simulation / Scoring ----------
  function nightSimulation(){
    // Freeze play
    setState(State.REPORT);

    // Evaluate checks -> incidents and penalties
    const c = game.checks;

    // Derived flags
    c.passwordStrongUnique = c.passwordStrong && c.passwordUnique && c.passwordChanged;

    c.networkSafe = c.unknownDeviceRemoved && c.guestWifiOff && c.firmwareUpdated;
    c.cloudSafe = c.cloudNoPublicLinks && c.cloudNoEveryone && c.cloudAlertsOn;
    c.socialSafe = c.socialPrivacyTight && c.socialFakeBlocked && c.socialDmRestricted;

    const errors = [];
    const incidents = [];

    function addPenalty(key){
      const p = PENALTIES[key];
      if(!p) return;
      errors.push({ key, pts:p.pts, msg:p.msg });
    }

    // Workstation
    if(!c.workstationLocked) addPenalty("workstation_unlocked");
    if(!c.usbRemoved) addPenalty("usb_left");
    if(!c.updatesOn) addPenalty("updates_off");
    if(!c.avRun) addPenalty("av_not_run");

    // Accounts
    if(!c.twoFAOn) addPenalty("twoFA_off");
    if(!c.passwordChanged) addPenalty("default_password");
    else {
      if(!c.passwordStrong) addPenalty("weak_password");
      if(!c.passwordUnique) addPenalty("reused_password");
    }
    if(!c.browserPwOff) addPenalty("browser_pw_on");

    // Mail
    if(!c.phishingSafe || c.phishingOpened>0) addPenalty("phishing_open");

    // Network
    if(!c.unknownDeviceRemoved) addPenalty("unknown_device");
    if(!c.guestWifiOff) addPenalty("guest_wifi_on");
    if(!c.firmwareUpdated) addPenalty("firmware_old");

    // Cloud
    if(!c.cloudNoPublicLinks) addPenalty("cloud_public");
    if(!c.cloudNoEveryone) addPenalty("cloud_everyone");
    if(!c.cloudAlertsOn) addPenalty("cloud_alerts_off");

    // Social
    if(!c.socialPrivacyTight) addPenalty("social_public");
    if(!c.socialFakeBlocked) addPenalty("social_fake_not_blocked");
    if(!c.socialDmRestricted) addPenalty("social_dm_open");

    // Hints penalties already applied directly to score, but record them as issues for report clarity
    if(game.hintsUsed > 0){
      for(let i=0;i<game.hintsUsed;i++) addPenalty("hint_used");
    }

    // Calculate final score
    const base = 100;
    const penaltySum = errors.reduce((s,e)=>s+e.pts, 0);
    const finalScore = clamp(base - penaltySum, 0, 100);

    // Determine win/lose based on critical checks
    const missingCritical = [];
    for(const k of CRITICAL_CHECKS){
      if(k === "passwordStrongUnique"){
        if(!c.passwordStrongUnique) missingCritical.push("–ü–∞—Ä–æ–ª—å: —Å–∏–ª—å–Ω—ã–π –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π");
      } else if(!c[k]){
        const map = {
          workstationLocked:"–ü–ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω",
          usbRemoved:"USB –∏–∑–≤–ª–µ—á—ë–Ω",
          updatesOn:"–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã",
          twoFAOn:"2FA –≤–∫–ª—é—á–µ–Ω–∞",
          browserPwOff:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤—ã–∫–ª—é—á–µ–Ω–æ",
          phishingSafe:"–ü–æ—á—Ç–∞: —Ñ–∏—à–∏–Ω–≥ –Ω–µ –æ—Ç–∫—Ä—ã—Ç",
          networkSafe:"–°–µ—Ç—å: –±–µ–∑–æ–ø–∞—Å–Ω–∞",
          cloudSafe:"–û–±–ª–∞–∫–æ: –±–µ–∑–æ–ø–∞—Å–Ω–æ",
          socialSafe:"–°–æ—Ü—Å–µ—Ç–∏: –±–µ–∑–æ–ø–∞—Å–Ω—ã"
        };
        missingCritical.push(map[k] || k);
      }
    }

    const win = missingCritical.length === 0;

    // Incidents story (non-graphic)
    if(!c.workstationLocked || !c.usbRemoved || !c.updatesOn){
      incidents.push("–ù–æ—á—å—é –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –∫ —Ä–∞–±–æ—á–µ–π —Å—Ç–∞–Ω—Ü–∏–∏/–Ω–æ—Å–∏—Ç–µ–ª—é –∏ –≤—ã–≥—Ä—É–∑–∏–ª —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.");
    }
    if(!c.passwordStrongUnique || !c.twoFAOn || !c.browserPwOff){
      incidents.push("–ù–æ—á—å—é —É—á—ë—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –±—ã–ª–∞ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ —Å–ª–∞–±—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é.");
    }
    if(!c.phishingSafe){
      incidents.push("–ù–æ—á—å—é —Å—Ä–∞–±–æ—Ç–∞–ª–∞ —Ü–µ–ø–æ—á–∫–∞ –∑–∞—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ø–æ—á—Ç—É (–≤—Ä–µ–¥–æ–Ω–æ—Å –∑–∞–∫—Ä–µ–ø–∏–ª—Å—è).");
    }
    if(!c.networkSafe){
      incidents.push("–ù–æ—á—å—é –∞—Ç–∞–∫–∞ –ø—Ä–∏—à–ª–∞ –∏–∑–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏ —á–µ—Ä–µ–∑ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ/–≥–æ—Å—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø/—É—è–∑–≤–∏–º—É—é –ø—Ä–æ—à–∏–≤–∫—É.");
    }
    if(!c.cloudSafe){
      incidents.push("–ù–æ—á—å—é –¥–æ–∫—É–º–µ–Ω—Ç—ã —É—Ç–µ–∫–ª–∏ —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–µ –ø—Ä–∞–≤–∞.");
    }
    if(!c.socialSafe){
      incidents.push("–ù–æ—á—å—é –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Å–æ—Ü–∏–Ω–∂–µ–Ω–µ—Ä–∏—è —á–µ—Ä–µ–∑ —Å–æ—Ü—Å–µ—Ç–∏ (—Ñ–µ–π–∫/–ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å/–õ–°).");
    }
    if(incidents.length === 0) incidents.push("–ù–æ—á—å –ø—Ä–æ—à–ª–∞ —Å–ø–æ–∫–æ–π–Ω–æ: —Ç—Ä–µ–≤–æ–≥ –∏ —É—Ç–µ—á–µ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.");

    // Render report UI
    el.report.style.display = "";
    el.reportTitle.textContent = win ? "–ü–æ–±–µ–¥–∞ ‚Äî –Ω–æ—á—å –±–µ–∑ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞" : "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ ‚Äî –Ω–æ—á–Ω–æ–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç";
    el.reportSubtitle.textContent = win
      ? "–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã. –û—Ñ–∏—Å –≤—ã–¥–µ—Ä–∂–∞–ª –Ω–æ—á–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É."
      : "–ù–µ –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–µ—Ä—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã. –ù–æ—á—å –ø–æ–∫–∞–∑–∞–ª–∞ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è (–±–µ–∑ –¥–µ—Ç–∞–ª–µ–π).";

    el.finalPct.textContent = `–ò—Ç–æ–≥: ${finalScore}%`;
    el.finalPct.className = "badge " + (finalScore>=85 ? "good" : finalScore>=60 ? "warn" : "bad");
    el.finalVerdict.textContent = win ? "–°—Ç–∞—Ç—É—Å: OK" : "–°—Ç–∞—Ç—É—Å: INCIDENT";
    el.finalVerdict.className = "badge " + (win ? "good" : "bad");

    const spent = game.dayLengthSec - game.timeLeftSec;
    el.finalTime.textContent = `–í—Ä–µ–º—è: ${fmtTime(spent)} / ${fmtTime(game.dayLengthSec)}`;

    el.finalSummary.innerHTML = "";
    const addSummary = (title, text, kind="") => {
      const d = document.createElement("div");
      d.className = "item";
      d.innerHTML = `<div class="top"><div><div class="name">${escapeHtml(title)}</div><div class="meta">${escapeHtml(text)}</div></div><div class="meta">${kind}</div></div>`;
      el.finalSummary.appendChild(d);
    };

    addSummary("–ù–æ—á–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è", incidents.join(" "));
    if(!win){
      addSummary("–ö—Ä–∏—Ç–∏—á–Ω–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ", missingCritical.join(" ¬∑ "), "‚ö†");
    } else {
      addSummary("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏", "–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ä—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.", "‚úì");
    }

    // Errors list
    const errBox = document.createElement("div");
    errBox.className = "item";
    const sorted = errors.sort((a,b)=>b.pts-a.pts);
    const errLines = sorted.length ? sorted.map(e=>`‚àí${e.pts}% ‚Äî ${e.msg}`).join("<br/>") : "–û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
    errBox.innerHTML = `<div class="name">–®—Ç—Ä–∞—Ñ—ã</div><div class="meta" style="margin-top:6px">${errLines}</div>`;
    el.finalSummary.appendChild(errBox);

    // Recommendations
    el.finalRecs.innerHTML = "";
    const recs = [];
    if(!c.workstationLocked) recs.push("–ü–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º –±–ª–æ–∫–∏—Ä—É–π —Å–µ—Å—Å–∏—é (Win+L) –∏ –Ω–µ –æ—Å—Ç–∞–≤–ª—è–π —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç—ã–º.");
    if(!c.usbRemoved) recs.push("–ù–µ –æ—Å—Ç–∞–≤–ª—è–π –Ω–æ—Å–∏—Ç–µ–ª–∏ –≤ –ü–ö. –î–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ ‚Äî —Ç–æ–ª—å–∫–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å.");
    if(!c.updatesOn) recs.push("–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –û–°/–ü–û –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã.");
    if(!c.twoFAOn) recs.push("–í–∫–ª—é—á–∞–π 2FA –Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —É—á—ë—Ç–∫–∞—Ö (–≤ –∏–¥–µ–∞–ª–µ ‚Äî –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ).");
    if(!c.passwordStrongUnique) recs.push("–°–∏–ª—å–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å + –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–≤—Ç–æ—Ä–æ–≤ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏.");
    if(!c.browserPwOff) recs.push("–ù–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å—Ç–∞–Ω—Ü–∏–∏ –æ—Ç–∫–ª—é—á–∞–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–∏–ª–∏ —É–ø—Ä–∞–≤–ª—è–π —á–µ—Ä–µ–∑ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä).");
    if(!c.phishingSafe) recs.push("–ü–æ—á—Ç—É –ø—Ä–æ–≤–µ—Ä—è–π –ø–æ –¥–æ–º–µ–Ω–∞–º/—Å—Ä–æ—á–Ω–æ—Å—Ç–∏/–≤–ª–æ–∂–µ–Ω–∏—è–º. –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ ‚Äî —Å–æ–æ–±—â–∞–π, –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—è.");
    if(!c.networkSafe) recs.push("–ö–æ–Ω—Ç—Ä–æ–ª—å —Å–µ—Ç–∏: –æ—Ç–∫–ª—é—á–∞—Ç—å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –≤—ã–∫–ª—é—á–∞—Ç—å –≥–æ—Å—Ç–µ–≤–æ–π Wi-Fi, –æ–±–Ω–æ–≤–ª—è—Ç—å —Ä–æ—É—Ç–µ—Ä.");
    if(!c.cloudSafe) recs.push("–í –æ–±–ª–∞–∫–µ –∑–∞–∫—Ä—ã–≤–∞–π –ø—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏, —É–±–∏—Ä–∞–π –¥–æ—Å—Ç—É–ø '–≤—Å–µ–º', –≤–∫–ª—é—á–∞–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥–∞—Ö.");
    if(!c.socialSafe) recs.push("–í —Å–æ—Ü—Å–µ—Ç—è—Ö —Å–Ω–∏–∂–∞–π –ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π –õ–°, –±–ª–æ–∫–∏—Ä—É–π —Ñ–µ–π–∫–∏ –∏ –∂–∞–ª—É–π—Å—è –Ω–∞ –Ω–∏—Ö.");
    if(game.hintsUsed>0) recs.push("–°—Ç–∞—Ä–∞–π—Å—è –æ–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã —ç–∫–æ–Ω–æ–º–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –ø–æ–≤—ã—à–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π %.");

    if(recs.length===0) recs.push("–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ —Å—Ç–∏–ª–µ: –¥–µ–π—Å—Ç–≤–∏—è —É—Å—Ç–æ–π—á–∏–≤—ã–µ –∫ –Ω–æ—á–Ω—ã–º —Å—Ü–µ–Ω–∞—Ä–∏—è–º.");
    for(const r of recs){
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `<div class="meta">${escapeHtml(r)}</div>`;
      el.finalRecs.appendChild(it);
    }

    // Final log
    el.finalLog.innerHTML = "";
    const logItems = game.logs.slice(-120);
    if(logItems.length===0){
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `<div class="meta">–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç.</div>`;
      el.finalLog.appendChild(it);
    } else {
      for(const e of logItems){
        const it = document.createElement("div");
        it.className = "item";
        it.innerHTML = `<div class="top"><div><div class="name">${escapeHtml(e.title)}</div><div class="meta">${escapeHtml(e.detail)}</div></div><div class="meta mono">${escapeHtml(e.ts)}</div></div>`;
        el.finalLog.appendChild(it);
      }
    }

    // store final score
    game.score = finalScore;
  }

  el.btnRestart.addEventListener("click", ()=>location.reload());

  // ---------- Input ----------
  window.addEventListener("keydown", (e)=>{
    if(e.code === "Tab"){
      e.preventDefault();
      if(game.state === State.PLAYING) openPhone();
      else if(game.state === State.MODAL) {
        // If task open, close task then phone
        if($("#tab_task")) closeTaskUI();
        closePhone();
      }
      return;
    }
    if(e.code === "Escape"){
      if(game.state === State.MODAL){
        if($("#tab_task")) closeTaskUI();
        closePhone();
        return;
      }
      if(game.state === State.PLAYING){
        setState(State.PAUSED);
        return;
      }
      if(game.state === State.PAUSED){
        setState(State.PLAYING);
        return;
      }
      return;
    }
    game.input.keys.add(e.code);
    // Interaction
    if(e.code === "KeyE"){
      if(game.state === State.PLAYING){
        interact.tryInteract();
      }
    }
  });
  window.addEventListener("keyup", (e)=> game.input.keys.delete(e.code));

  // Mouse look
  window.addEventListener("mousemove", (e)=>{
    if(!game.input.pointerLocked) return;
    game.input.mouseDX += e.movementX || 0;
    game.input.mouseDY += e.movementY || 0;
  });

  document.addEventListener("pointerlockchange", ()=>{
    game.input.pointerLocked = (document.pointerLockElement === el.threeCanvas || document.pointerLockElement === el.fbCanvas);
    updateHUD();
  });

  function requestPointerLock(){
    const canvas = (game.rendererMode === "three") ? el.threeCanvas : el.fbCanvas;
    if(canvas.requestPointerLock) canvas.requestPointerLock();
  }
  function closePointerLock(){
    if(document.pointerLockElement) document.exitPointerLock?.();
  }

  el.btnLockMouse.addEventListener("click", requestPointerLock);

  // ---------- Rendering Backends ----------
  const render = {
    pixelScale: 0.35, // lower -> chunkier pixels
    setPixelScale(v){
      render.pixelScale = clamp(v, 0.18, 0.75);
      if(game.rendererMode === "three") three.setPixelScale(render.pixelScale);
      else fallback.setPixelScale(render.pixelScale);
    }
  };

  // ----- Three.js backend (optional) -----
  const three = {
    enabled:false,
    THREE:null,
    // scene objects
    scene:null, camera:null, world:null,
    // low-res render target + blit
    gl:null,
    rt:null,
    rtW:0, rtH:0,

    // player
    yaw: 0,
    pitch: 0,
    pos: {x:0, y:1.65, z:0},
    vel: {x:0, z:0},

    // interactables (mesh + id + label + zone)
    interactables: [],

    init(THREE){
      this.enabled = true;
      this.THREE = THREE;

      // Setup WebGL renderer
      const gl = new THREE.WebGLRenderer({
        canvas: el.threeCanvas,
        antialias: false,
        alpha: false,
        powerPreference: "high-performance"
      });
      gl.setClearColor(0x0b0f14, 1);
      gl.outputColorSpace = THREE.SRGBColorSpace;
      gl.toneMapping = THREE.NoToneMapping;
      gl.shadowMap.enabled = false;
      this.gl = gl;

      this.scene = new THREE.Scene();
      this.scene.fog = new THREE.FogExp2(0x0b0f14, 0.035);

      this.camera = new THREE.PerspectiveCamera(70, 1, 0.05, 80);
      this.camera.position.set(this.pos.x, this.pos.y, this.pos.z);

      // Lights
      const hemi = new THREE.HemisphereLight(0x9db4ff, 0x2a2f3a, 0.9);
      this.scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 0.35);
      dir.position.set(8, 10, 3);
      this.scene.add(dir);

      // World group
      this.world = new THREE.Group();
      this.scene.add(this.world);

      // Build office layout (procedural boxes)
      this.buildOffice();

      // Pixelation target
      this.setPixelScale(render.pixelScale);
      this.resize();

      // Start at entrance
      this.pos = {x:-8, y:1.65, z:5};
      this.yaw = Math.PI * 0.15;
      this.pitch = 0;
    },

    setPixelScale(scale){
      // Recreate RT on next resize
      this.pixelScale = scale;
      this.resize(true);
    },

    resize(force=false){
      if(!this.enabled) return;
      const w = Math.max(2, el.gameWrap?.clientWidth || el.threeCanvas.clientWidth || window.innerWidth);
      const h = Math.max(2, el.gameWrap?.clientHeight || el.threeCanvas.clientHeight || window.innerHeight);
      this.camera.aspect = w / h;
      this.camera.updateProjectionMatrix();

      // Low-res target size
      const rtW = Math.max(64, Math.floor(w * this.pixelScale));
      const rtH = Math.max(64, Math.floor(h * this.pixelScale));

      // Set renderer size to screen; render into RT then draw to screen via full-res pass:
      // We avoid postprocessing libs and use WebGLRenderer.setRenderTarget + copyTextureToTexture-like approach
      // Simpler: render RT to canvas by setting renderer size to RT, then upscale canvas via CSS.
      // Implementation: set internal drawing buffer to RT size and rely on CSS upscale.
      // (This keeps true pixelated look, and works offline.)
      this.gl.setSize(rtW, rtH, false);
      el.threeCanvas.style.width = "100%";
      el.threeCanvas.style.height = "100%";
      // Remember for info
      this.rtW = rtW; this.rtH = rtH;
    },

    buildOffice(){
      const THREE = this.THREE;
      const g = this.world;

      // Materials (flat-ish to mimic pixel art)
      const matFloor = new THREE.MeshLambertMaterial({color:0x101826});
      const matWall  = new THREE.MeshLambertMaterial({color:0x162235});
      const matTrim  = new THREE.MeshLambertMaterial({color:0x2a3b55});
      const matDesk  = new THREE.MeshLambertMaterial({color:0x2b2a2c});
      const matScreen= new THREE.MeshLambertMaterial({color:0x0b111a, emissive:0x102a2a, emissiveIntensity:0.35});
      const matTerm  = new THREE.MeshLambertMaterial({color:0x1b2434});
      const matDoor  = new THREE.MeshLambertMaterial({color:0x25364f});
      const matGlow  = new THREE.MeshLambertMaterial({color:0x1f8f68});

      // Floor
      const floor = new THREE.Mesh(new THREE.BoxGeometry(26, 1, 18), matFloor);
      floor.position.set(0, -0.5, 0);
      g.add(floor);

      // Walls (simple rectangle)
      function wall(x,z,w,h,d){
        const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), matWall);
        m.position.set(x,h/2-0.0,z);
        g.add(m);
        return m;
      }
      wall(0, -9, 26, 4, 1);
      wall(0,  9, 26, 4, 1);
      wall(-13, 0, 1, 4, 18);
      wall( 13, 0, 1, 4, 18);

      // Inner partitions to suggest 6 zones
      wall(-4.5, 0, 1, 3.2, 14);
      wall(4.5, 0, 1, 3.2, 14);
      // horizontal partitions
      wall(0, -2.6, 8.8, 3.2, 1);
      wall(0,  2.6, 8.8, 3.2, 1);

      // Zone sign (bright trim blocks)
      function sign(x,z,text){
        const s = new THREE.Mesh(new THREE.BoxGeometry(2.8,0.25,0.25), matTrim);
        s.position.set(x,2.55,z);
        g.add(s);
        // tiny emissive dot to guide
        const dot = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.2), matGlow);
        dot.position.set(x,2.2,z+0.2);
        g.add(dot);
        // store as non-interactive landmark
        return {mesh:s, text};
      }

      // Layout (left to right, top to bottom)
      // Zones positions:
      const zones = [
        { id:"workstation", name:"–≠—Ç–∞–ø 1: –†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ", x:-9, z:-6 },
        { id:"accounts",    name:"–≠—Ç–∞–ø 2: –£—á—ë—Ç–∫–∏",        x:-9, z:  6 },
        { id:"mail",        name:"–≠—Ç–∞–ø 3: –ü–æ—á—Ç–∞",         x: 0, z:-6 },
        { id:"network",     name:"–≠—Ç–∞–ø 4: –°–µ—Ç—å",          x: 0, z:  6 },
        { id:"cloud",       name:"–≠—Ç–∞–ø 5: –û–±–ª–∞–∫–æ",        x: 9, z:-6 },
        { id:"social",      name:"–≠—Ç–∞–ø 6: –°–æ—Ü—Å–µ—Ç–∏",       x: 9, z:  6 },
      ];
      zones.forEach(z => sign(z.x, z.z-2.2, z.name));

      // Helper to add interactable terminal
      const addInteractable = (id, label, x,y,z, sx,sy,sz, mat, zoneName) => {
        const m = new THREE.Mesh(new THREE.BoxGeometry(sx,sy,sz), mat);
        m.position.set(x,y,z);
        m.userData = {id, label, zoneName};
        g.add(m);
        this.interactables.push(m);
        return m;
      };

      // Workstation props: desk + PC + monitor + usb
      const desk = new THREE.Mesh(new THREE.BoxGeometry(2.6,0.8,1.3), matDesk);
      desk.position.set(-9,0.4,-6);
      g.add(desk);
      addInteractable("workstation", "–ü–ö –∏ —Å—Ç–æ–ª", -9, 1.15, -5.5, 0.9,0.55,0.35, matScreen, "–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ");

      const usb = new THREE.Mesh(new THREE.BoxGeometry(0.18,0.06,0.32), new THREE.MeshLambertMaterial({color:0xffcc66}));
      usb.position.set(-8.5, 0.86, -6.2);
      usb.userData = {id:"workstation", label:"USB-—Ñ–ª–µ—à–∫–∞", zoneName:"–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ"};
      g.add(usb);
      this.interactables.push(usb);

      // Accounts terminal (laptop)
      const lapBase = new THREE.Mesh(new THREE.BoxGeometry(1.1,0.12,0.75), matTerm);
      lapBase.position.set(-9, 0.85, 6);
      g.add(lapBase);
      addInteractable("accounts", "–¢–µ—Ä–º–∏–Ω–∞–ª —É—á—ë—Ç–æ–∫", -9, 1.25, 6, 0.9,0.55,0.15, matScreen, "–£—á—ë—Ç–∫–∏ –∏ –ø–∞—Ä–æ–ª–∏");

      // Mail terminal
      const mailStand = new THREE.Mesh(new THREE.BoxGeometry(0.6,1.0,0.6), matTerm);
      mailStand.position.set(0,0.5,-6);
      g.add(mailStand);
      addInteractable("mail", "–ü–æ—á—Ç–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª", 0, 1.35, -6, 1.0,0.7,0.15, matScreen, "–ü–æ—á—Ç–∞");

      // Network rack/router
      const rack = new THREE.Mesh(new THREE.BoxGeometry(1.2,1.4,0.8), matTerm);
      rack.position.set(0,0.7,6);
      g.add(rack);
      const router = addInteractable("network", "–†–æ—É—Ç–µ—Ä/—â–∏—Ç–æ–∫", 0, 1.5, 6, 1.2,0.6,0.35, matScreen, "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç—å");
      // blinking light cube as hint
      const led = new THREE.Mesh(new THREE.BoxGeometry(0.12,0.12,0.12), matGlow);
      led.position.set(0.55, 1.35, 6.25);
      led.userData.blink = true;
      g.add(led);

      // Cloud terminal
      const cloudStand = new THREE.Mesh(new THREE.BoxGeometry(0.6,1.0,0.6), matTerm);
      cloudStand.position.set(9,0.5,-6);
      g.add(cloudStand);
      addInteractable("cloud", "–û–±–ª–∞—á–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª", 9, 1.35, -6, 1.0,0.7,0.15, matScreen, "–û–±–ª–∞–∫–æ");

      // Social terminal
      const socStand = new THREE.Mesh(new THREE.BoxGeometry(0.6,1.0,0.6), matTerm);
      socStand.position.set(9,0.5,6);
      g.add(socStand);
      addInteractable("social", "–¢–µ—Ä–º–∏–Ω–∞–ª —Å–æ—Ü—Å–µ—Ç–µ–π", 9, 1.35, 6, 1.0,0.7,0.15, matScreen, "–°–æ—Ü—Å–µ—Ç–∏");

      // Go Home door
      const door = new THREE.Mesh(new THREE.BoxGeometry(2.0,2.9,0.35), matDoor);
      door.position.set(12.0, 1.45, 0);
      door.userData = {id:"home", label:"–î–≤–µ—Ä—å –¥–æ–º–æ–π", zoneName:"–í—ã—Ö–æ–¥"};
      g.add(door);
      this.interactables.push(door);

      // Decorative columns (helps navigation)
      for(let i=0;i<8;i++){
        const col = new THREE.Mesh(new THREE.BoxGeometry(0.35,2.2,0.35), matTrim);
        col.position.set(-11.5 + (i%4)*7.5, 1.1, -8 + Math.floor(i/4)*16);
        g.add(col);
      }

      // Place a few ‚Äústicker‚Äù panels (non-interactive)
      function sticker(x,z,text){
        const s = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.4,0.05), new THREE.MeshLambertMaterial({color:0xffe58a}));
        s.position.set(x, 1.7, z);
        s.rotation.y = (x<0? Math.PI/2 : -Math.PI/2);
        g.add(s);
      }
      sticker(-11.6,-5.8,"Win+L");
      sticker(-11.6, 6.3,"2FA");
      sticker( 11.6,-5.8,"Links?");
      sticker( 11.6, 6.3,"Fakes?");

      // Store blinkers
      this.blinkers = g.children.filter(o => o.userData && o.userData.blink);
    },

    tick(dt){
      const THREE = this.THREE;

      // blink
      const t = now() * 0.004;
      if(this.blinkers){
        for(const b of this.blinkers){
          b.visible = (Math.sin(t) > -0.15);
        }
      }

      // mouse look
      const sens = 0.0022;
      this.yaw   -= game.input.mouseDX * sens;
      this.pitch -= game.input.mouseDY * sens;
      game.input.mouseDX = 0; game.input.mouseDY = 0;
      this.pitch = clamp(this.pitch, -1.35, 1.35);

      // movement
      const speed = 4.0;
      const accel = 18.0;
      const friction = 10.0;

      let ix = 0, iz = 0;
      const k = game.input.keys;
      const up = k.has("KeyW") || k.has("ArrowUp");
      const dn = k.has("KeyS") || k.has("ArrowDown");
      const lt = k.has("KeyA") || k.has("ArrowLeft");
      const rt = k.has("KeyD") || k.has("ArrowRight");
      if(up) iz -= 1;
      if(dn) iz += 1;
      if(lt) ix -= 1;
      if(rt) ix += 1;
      const len = Math.hypot(ix, iz) || 1;
      ix/=len; iz/=len;

      const forward = {x: Math.sin(this.yaw), z: Math.cos(this.yaw)};
      const right = {x: Math.cos(this.yaw), z: -Math.sin(this.yaw)};
      const wishX = (forward.x * iz + right.x * ix) * speed;
      const wishZ = (forward.z * iz + right.z * ix) * speed;

      // accelerate to wish
      this.vel.x += (wishX - this.vel.x) * clamp(dt*accel, 0, 1);
      this.vel.z += (wishZ - this.vel.z) * clamp(dt*accel, 0, 1);

      // friction when no input
      if(ix===0 && iz===0){
        this.vel.x -= this.vel.x * clamp(dt*friction, 0, 1);
        this.vel.z -= this.vel.z * clamp(dt*friction, 0, 1);
      }

      // integrate + simple bounds collision
      const nextX = this.pos.x + this.vel.x * dt;
      const nextZ = this.pos.z + this.vel.z * dt;

      // world bounds (inside outer walls)
      this.pos.x = clamp(nextX, -11.5, 11.5);
      this.pos.z = clamp(nextZ, -8.0, 8.0);

      // bump from inner partitions (approx)
      // vertical partitions at x=-4.5 and x=4.5 across z in [-7,7]
      const bump = 0.22;
      if(this.pos.z>-7 && this.pos.z<7){
        if(Math.abs(this.pos.x + 4.5) < bump) this.pos.x = (this.pos.x < -4.5) ? -4.5-bump : -4.5+bump;
        if(Math.abs(this.pos.x - 4.5) < bump) this.pos.x = (this.pos.x <  4.5) ?  4.5-bump :  4.5+bump;
      }
      // horizontal partitions at z=-2.6 and z=2.6 for x in [-4.4,4.4]
      if(this.pos.x>-4.2 && this.pos.x<4.2){
        if(Math.abs(this.pos.z + 2.6) < bump) this.pos.z = (this.pos.z < -2.6) ? -2.6-bump : -2.6+bump;
        if(Math.abs(this.pos.z - 2.6) < bump) this.pos.z = (this.pos.z <  2.6) ?  2.6-bump :  2.6+bump;
      }

      // Update camera
      this.camera.position.set(this.pos.x, this.pos.y, this.pos.z);
      this.camera.rotation.order = "YXZ";
      this.camera.rotation.y = this.yaw;
      this.camera.rotation.x = this.pitch;

      // Determine zone label by position quadrant (soft)
      game.currentZone = zoneNameFromPos(this.pos.x, this.pos.z);

      // Interact prompt via raycast
      interact.updateThree(this.camera, this.interactables);

      // render (low-res internal buffer)
      this.gl.render(this.scene, this.camera);
    }
  };

  function zoneNameFromPos(x,z){
    // Map to 6 zones + exit (door)
    if(x > 10.4 && Math.abs(z) < 2.2) return "–í—ã—Ö–æ–¥";
    const left = x < -4.5;
    const right = x > 4.5;
    const top = z > 0;
    if(left && !top) return "–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ";
    if(left && top)  return "–£—á—ë—Ç–∫–∏ –∏ –ø–∞—Ä–æ–ª–∏";
    if(!left && !right && !top) return "–ü–æ—á—Ç–∞";
    if(!left && !right && top)  return "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç—å";
    if(right && !top) return "–û–±–ª–∞–∫–æ";
    if(right && top)  return "–°–æ—Ü—Å–µ—Ç–∏";
    return "–û—Ñ–∏—Å";
  }

  // ----- Fallback backend (offline, no three.js) -----
  const fallback = {
    enabled:false,
    ctx:null,
    w:0,h:0,
    scale: 0.35,
    // player (2D top-down but same zones)
    x:-8, z:5,
    yaw:0,
    velx:0, velz:0,
    interactables: [],
    init(){
      this.enabled = true;
      el.fbCanvas.style.display = "block";
      el.threeCanvas.style.display = "none";
      const c = el.fbCanvas;
      this.ctx = c.getContext("2d", {alpha:false, desynchronized:true});
      this.setPixelScale(render.pixelScale);
      this.resize();
      this.build();
    },
    setPixelScale(scale){
      this.scale = scale;
      this.resize(true);
    },
    resize(force=false){
      const W = Math.max(2, el.gameWrap.clientWidth || window.innerWidth);
      const H = Math.max(2, el.gameWrap.clientHeight || window.innerHeight);
      // internal low-res buffer
      this.w = Math.max(160, Math.floor(W * this.scale));
      this.h = Math.max(120, Math.floor(H * this.scale));
      el.fbCanvas.width = this.w;
      el.fbCanvas.height = this.h;
      el.fbCanvas.style.width = "100%";
      el.fbCanvas.style.height = "100%";
    },
    build(){
      // In fallback, interactables are rectangles in world space (same coords as 3D)
      // We'll use simple AABB checks around player.
      this.interactables = [
        {id:"workstation", label:"–ü–ö –∏ —Å—Ç–æ–ª", x:-9, z:-6, r:1.1, zoneName:"–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ"},
        {id:"accounts", label:"–¢–µ—Ä–º–∏–Ω–∞–ª —É—á—ë—Ç–æ–∫", x:-9, z:6, r:1.2, zoneName:"–£—á—ë—Ç–∫–∏ –∏ –ø–∞—Ä–æ–ª–∏"},
        {id:"mail", label:"–ü–æ—á—Ç–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª", x:0, z:-6, r:1.2, zoneName:"–ü–æ—á—Ç–∞"},
        {id:"network", label:"–†–æ—É—Ç–µ—Ä/—â–∏—Ç–æ–∫", x:0, z:6, r:1.3, zoneName:"–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç—å"},
        {id:"cloud", label:"–û–±–ª–∞—á–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª", x:9, z:-6, r:1.2, zoneName:"–û–±–ª–∞–∫–æ"},
        {id:"social", label:"–¢–µ—Ä–º–∏–Ω–∞–ª —Å–æ—Ü—Å–µ—Ç–µ–π", x:9, z:6, r:1.2, zoneName:"–°–æ—Ü—Å–µ—Ç–∏"},
        {id:"home", label:"–î–≤–µ—Ä—å –¥–æ–º–æ–π", x:12, z:0, r:1.2, zoneName:"–í—ã—Ö–æ–¥"},
      ];
    },
    tick(dt){
      // movement
      const k = game.input.keys;
      let ix=0, iz=0;
      if(k.has("KeyW")||k.has("ArrowUp")) iz -= 1;
      if(k.has("KeyS")||k.has("ArrowDown")) iz += 1;
      if(k.has("KeyA")||k.has("ArrowLeft")) ix -= 1;
      if(k.has("KeyD")||k.has("ArrowRight")) ix += 1;
      const len = Math.hypot(ix,iz) || 1;
      ix/=len; iz/=len;

      const speed = 4.2;
      const accel = 16.0;
      const friction = 10.0;
      const wishX = ix * speed;
      const wishZ = iz * speed;

      this.velx += (wishX - this.velx) * clamp(dt*accel,0,1);
      this.velz += (wishZ - this.velz) * clamp(dt*accel,0,1);
      if(ix===0 && iz===0){
        this.velx -= this.velx * clamp(dt*friction,0,1);
        this.velz -= this.velz * clamp(dt*friction,0,1);
      }

      this.x = clamp(this.x + this.velx*dt, -11.5, 11.5);
      this.z = clamp(this.z + this.velz*dt, -8.0, 8.0);

      // zone
      game.currentZone = zoneNameFromPos(this.x, this.z);

      // interaction prompt (nearest within radius)
      interact.updateFallback(this.x, this.z, this.interactables);

      // draw
      this.draw();
    },
    draw(){
      const ctx = this.ctx;
      const w = this.w, h = this.h;
      // Map world coords [-13..13]x[-9..9] to screen
      const toX = (x)=> (x+13)/26 * w;
      const toY = (z)=> (z+9)/18 * h;

      ctx.fillStyle = "#0b0f14";
      ctx.fillRect(0,0,w,h);

      // floor
      ctx.fillStyle = "#101826";
      ctx.fillRect(0,0,w,h);

      // partitions
      ctx.fillStyle = "#162235";
      // outer border
      ctx.fillRect(0,0,w,2);
      ctx.fillRect(0,h-2,w,2);
      ctx.fillRect(0,0,2,h);
      ctx.fillRect(w-2,0,2,h);
      // verticals x=-4.5, +4.5
      const vx1 = toX(-4.5), vx2 = toX(4.5);
      ctx.fillRect(vx1-1, toY(-7), 2, toY(7)-toY(-7));
      ctx.fillRect(vx2-1, toY(-7), 2, toY(7)-toY(-7));
      // horizontals z=-2.6, +2.6 (between x=-4.2..4.2)
      const hz1 = toY(-2.6), hz2 = toY(2.6);
      ctx.fillRect(toX(-4.2), hz1-1, toX(4.2)-toX(-4.2), 2);
      ctx.fillRect(toX(-4.2), hz2-1, toX(4.2)-toX(-4.2), 2);

      // interactables
      for(const it of this.interactables){
        const px = toX(it.x), py = toY(it.z);
        ctx.fillStyle = (it.id==="home") ? "#25364f" : "#0b111a";
        ctx.fillRect(px-4, py-4, 8, 8);
        ctx.fillStyle = "#4de3a8";
        ctx.fillRect(px-1, py-1, 2, 2);
      }

      // player
      const px = toX(this.x), py = toY(this.z);
      ctx.fillStyle = "#e8eef7";
      ctx.fillRect(px-2, py-2, 4, 4);
      ctx.fillStyle = "#ffcc66";
      ctx.fillRect(px+3, py-1, 2, 2);

      // UI hint labels
      ctx.fillStyle = "rgba(232,238,247,.85)";
      ctx.font = "10px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillText("Fallback renderer (offline)", 6, 12);
    }
  };

  // ---------- Interaction system ----------
  const interact = {
    hover: null, // {id,label,zoneName}
    promptVisible:false,

    showPrompt(on, big, small){
      el.prompt.style.opacity = on ? "1" : "0";
      el.promptBig.textContent = big || "E: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å";
      el.promptSmall.textContent = small || "";
      this.promptVisible = on;
    },

    updateThree(camera, meshes){
      // raycast from center
      if(!three.enabled) return;
      const THREE = three.THREE;
      if(!this.raycaster) this.raycaster = new THREE.Raycaster();
      if(!this.ndc) this.ndc = new THREE.Vector2(0,0);

      this.raycaster.setFromCamera(this.ndc, camera);
      this.raycaster.far = 2.4;

      const hits = this.raycaster.intersectObjects(meshes, false);
      if(hits && hits.length){
        const obj = hits[0].object;
        const ud = obj.userData || {};
        this.hover = {id: ud.id, label: ud.label, zoneName: ud.zoneName};
        this.showPrompt(true, "E: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å", ud.label ? ud.label : "");
      } else {
        this.hover = null;
        this.showPrompt(false);
      }
    },

    updateFallback(px,pz, items){
      let best = null, bestD = 1e9;
      for(const it of items){
        const d = Math.hypot(px-it.x, pz-it.z);
        if(d < it.r && d < bestD){
          bestD = d; best = it;
        }
      }
      if(best){
        this.hover = {id: best.id, label: best.label, zoneName: best.zoneName};
        this.showPrompt(true, "E: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å", best.label);
      } else {
        this.hover = null;
        this.showPrompt(false);
      }
    },

    tryInteract(){
      if(!this.hover) return;
      // open relevant task
      openTaskUI(this.hover.id);
      logEvent("–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ", `–û—Ç–∫—Ä—ã—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: ${this.hover.label}.`);
    }
  };

  // ---------- Main Loop ----------
  function tick(){
    const t = now();
    const dt = clamp((t - game.lastTick) / 1000, 0, 0.05);
    game.lastTick = t;

    if(game.state === State.PLAYING){
      game.timeLeftSec -= dt;
      if(game.timeLeftSec <= 0){
        game.timeLeftSec = 0;
        logEvent("–í—Ä–µ–º—è", "–°–º–µ–Ω–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å. –ù–æ—á—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.");
        nightSimulation();
      }

      if(game.rendererMode === "three") three.tick(dt);
      else fallback.tick(dt);
    } else if(game.state === State.PAUSED){
      // no simulation
    } else if(game.state === State.MODAL){
      // modal open; still allow timer to run (pressure)
      game.timeLeftSec -= dt * 0.75; // slightly slower while reading
      if(game.timeLeftSec <= 0){
        game.timeLeftSec = 0;
        nightSimulation();
      }
      // Keep prompt off while modal
      interact.showPrompt(false);
      // Still tick renderer softly for blink
      if(game.rendererMode === "three" && three.enabled) {
        three.tick(Math.min(dt, 0.016));
      } else if(game.rendererMode === "fallback" && fallback.enabled){
        fallback.tick(Math.min(dt, 0.016));
      }
    }

    updateHUD();
    requestAnimationFrame(tick);
  }

  // ---------- Start / Boot ----------
  function resetGame(){
    game.score = 100;
    game.hintsLeft = 3;
    game.hintsUsed = 0;
    game.logs = [];
    game.scenario = buildScenario();
    for(const k of Object.keys(game.checks)){
      if(typeof game.checks[k] === "boolean") game.checks[k] = false;
      if(k === "phishingSafe") game.checks[k] = true;
      if(k === "phishingReported") game.checks[k] = 0;
      if(k === "phishingOpened") game.checks[k] = 0;
    }
    // Derived cloud flags depend on scenario; set to false initially and recompute when opening UI
    game.timeLeftSec = game.dayLengthSec;
    renderLogList();
    updateHUD();
  }

  function startGame(){
    resetGame();
    el.overlay.classList.add("hidden");
    el.report.style.display = "none";
    setState(State.PLAYING);
    game.lastTick = now();
    game.startedAt = now();
    logEvent("–°—Ç–∞—Ä—Ç", "–°–º–µ–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å. –û—Å–º–æ—Ç—Ä–∏—Å—å –ø–æ –∑–æ–Ω–∞–º –∏ —É–±–µ—Ä–∏ —Ä–∏—Å–∫–∏.");
    requestAnimationFrame(tick);
  }

  el.btnStart.addEventListener("click", startGame);

  // Click canvas to lock mouse in playing
  el.threeCanvas.addEventListener("click", ()=>{
    if(game.state === State.PLAYING && !game.input.pointerLocked) requestPointerLock();
  });
  el.fbCanvas.addEventListener("click", ()=>{
    if(game.state === State.PLAYING && !game.input.pointerLocked) requestPointerLock();
  });

  // Close phone with button, also restore tabs if task was open
  el.phone.addEventListener("click", (e)=>{
    if(e.target === el.phone){
      if($("#tab_task")) closeTaskUI();
      closePhone();
    }
  });

  // Report close handling: keep on screen until restart
  el.report.addEventListener("click", (e)=>{
    // no close by background; restart only
  });

  // Window resize
  window.addEventListener("resize", ()=>{
    if(game.rendererMode === "three" && three.enabled) three.resize();
    if(game.rendererMode === "fallback" && fallback.enabled) fallback.resize();
  });

  // ---------- CDN load with offline fallback ----------
  function loadThreeFromCDN(){
    return new Promise((resolve, reject)=>{
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js";
      s.async = true;
      s.onload = ()=> resolve(window.THREE);
      s.onerror = ()=> reject(new Error("Three.js CDN failed"));
      document.head.appendChild(s);
    });
  }

  async function boot(){
    setState(State.MENU);

    // Try Three.js; if fails, fallback
    try{
      const THREE = await loadThreeFromCDN();
      if(!THREE) throw new Error("Three undefined");
      game.rendererMode = "three";
      el.renderBadge.textContent = "Renderer: Three.js (pixel)";
      el.renderBadge.className = "badge good";
      three.init(THREE);
      el.fbCanvas.style.display = "none";
      el.threeCanvas.style.display = "block";
    } catch (e){
      game.rendererMode = "fallback";
      el.renderBadge.textContent = "Renderer: Fallback (offline)";
      el.renderBadge.className = "badge warn";
      fallback.init();
    }

    render.setPixelScale(render.pixelScale);
    updateHUD();
  }

  // ---------- Small UX: show zone-related ambient messages ----------
  let ambientTimer = 0;
  setInterval(()=>{
    if(game.state !== State.PLAYING) return;
    // Occasional ambient hints without checklist
    ambientTimer++;
    if(ambientTimer % 22 !== 0) return;

    const z = game.currentZone;
    const c = game.checks;

    const pool = [];
    if(z==="–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ" && (!c.workstationLocked || !c.usbRemoved || !c.updatesOn)) pool.push(["–°—Ç–∏–∫–µ—Ä", "–ù–∞ –º–æ–Ω–∏—Ç–æ—Ä–µ –∑–∞–º–µ—Ç–∫–∞ –ø—Ä–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É, –Ω–æ—Å–∏—Ç–µ–ª–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è."]);
    if(z==="–£—á—ë—Ç–∫–∏ –∏ –ø–∞—Ä–æ–ª–∏" && (!c.twoFAOn || !c.passwordChanged || !c.browserPwOff)) pool.push(["–ß–∞—Ç –∫–æ–ª–ª–µ–≥–∏", "¬´–ü—Ä–æ–≤–µ—Ä—å 2FA –∏ —á—Ç–æ –ø–∞—Ä–æ–ª—å –Ω–µ 'Welcome123'¬ª"]);
    if(z==="–ü–æ—á—Ç–∞" && c.phishingReported===0) pool.push(["–ü–æ—á—Ç–∞", "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–∏—Å—å–º–∞ –≤—ã–≥–ª—è–¥—è—Ç ¬´—Å–ª–∏—à–∫–æ–º —Å—Ä–æ—á–Ω–æ¬ª."]);
    if(z==="–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç—å" && (!c.firmwareUpdated || !c.unknownDeviceRemoved)) pool.push(["–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–µ—Ç–∏", "–ú–∏–≥–∞–µ—Ç –ª–∞–º–ø–æ—á–∫–∞ ¬´–Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ¬ª/¬´–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ¬ª."]);
    if(z==="–û–±–ª–∞–∫–æ" && (!c.cloudNoPublicLinks || !c.cloudNoEveryone || !c.cloudAlertsOn)) pool.push(["–û–±–ª–∞–∫–æ", "–ü–∞–Ω–µ–ª—å –Ω–∞–º–µ–∫–∞–µ—Ç –Ω–∞ –æ–±—â–∏–µ —Å—Å—ã–ª–∫–∏ –∏ —à–∏—Ä–æ–∫–∏–µ –ø—Ä–∞–≤–∞."]);
    if(z==="–°–æ—Ü—Å–µ—Ç–∏" && (!c.socialFakeBlocked || !c.socialPrivacyTight)) pool.push(["–°–æ—Ü—Å–µ—Ç–∏", "–í–∏–¥–Ω–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —É –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏."]);
    if(pool.length){
      const [t,d] = choice(pool);
      logEvent(t, d);
    }
  }, 1000);

  // ---------- Start boot ----------
  boot();

})();
</script>

<!--
–ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å:
- –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π index.html –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω: –µ—Å—Ç—å fallback).
–ö–ª–∞–≤–∏—à–∏:
- WASD / —Å—Ç—Ä–µ–ª–∫–∏ ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ
- –ú—ã—à—å ‚Äî –æ–±–∑–æ—Ä (–Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É/–∫–ª–∏–∫ –ø–æ —Å—Ü–µ–Ω–µ –¥–ª—è Pointer Lock)
- E ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å
- Tab ‚Äî —Å–º–∞—Ä—Ç—Ñ–æ–Ω/–ø–∞–Ω–µ–ª—å (–ø–æ–º–æ—â—å/–∂—É—Ä–Ω–∞–ª/–ø–æ–¥—Å–∫–∞–∑–∫–∞)
- Esc ‚Äî –ø–∞—É–∑–∞/–≤—ã—Ö–æ–¥ –∏–∑ pointer lock / –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–µ–π
-->
</body>
</html>
